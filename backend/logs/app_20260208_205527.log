2026-02-08 20:55:27,129 - main - INFO - === Logging system initialized ===
2026-02-08 20:55:27,129 - main - INFO - Log file: logs/app_20260208_205527.log
2026-02-08 20:55:27,130 - main - INFO - Log level: INFO
2026-02-08 20:55:27,130 - main - INFO - Timestamp: 20260208_205527
2026-02-08 20:55:27,792 - main - INFO - Included router: routers.aihub.router
2026-02-08 20:55:27,816 - main - INFO - Included router: routers.auth.router
2026-02-08 20:55:27,887 - main - INFO - Included router: routers.documents.router
2026-02-08 20:55:27,977 - main - INFO - Included router: routers.extractions.router
2026-02-08 20:55:27,994 - main - INFO - Included router: routers.health.router
2026-02-08 20:55:28,142 - main - INFO - Included router: routers.lease_analysis.router
2026-02-08 20:55:28,200 - main - INFO - Included router: routers.payments.router
2026-02-08 20:55:28,226 - main - INFO - Included router: routers.settings.router
2026-02-08 20:55:28,286 - main - INFO - Included router: routers.state_regulations.router
2026-02-08 20:55:28,337 - main - INFO - Included router: routers.storage.router
2026-02-08 20:55:28,366 - core.config - DEBUG - Read dynamic attribute stripe_secret_key from environment variable STRIPE_SECRET_KEY
2026-02-08 20:55:28,377 - main - INFO - Included router: routers.stripe_payments.router
2026-02-08 20:55:28,387 - main - INFO - Included router: routers.user.router
2026-02-08 20:55:28,436 - main - INFO - Included router: routers.user_credits.router
2026-02-08 20:55:28,438 - main - INFO - === Application startup initiated ===
2026-02-08 20:55:28,438 - services.database - DEBUG - [DB_OP] Starting database initialization
2026-02-08 20:55:28,438 - services.database - INFO - ðŸ”§ Starting database initialization...
2026-02-08 20:55:28,438 - core.database - INFO - Starting database initialization...
2026-02-08 20:55:28,438 - core.config - DEBUG - Read dynamic attribute database_url from environment variable DATABASE_URL
2026-02-08 20:55:28,439 - core.database - INFO - Normalizing database URL for async compatibility...
2026-02-08 20:55:28,441 - core.database - INFO - Creating async database engine...
2026-02-08 20:55:28,441 - core.database - INFO - Using QueuePool with connection pooling for non-Lambda environment
2026-02-08 20:55:28,496 - core.database - INFO - Database engine created successfully
2026-02-08 20:55:28,496 - core.database - INFO - Creating async session maker...
2026-02-08 20:55:28,497 - core.database - INFO - Async session maker created successfully
2026-02-08 20:55:28,497 - core.database - INFO - Database connection initialized successfully
2026-02-08 20:55:28,497 - services.database - INFO - ðŸ”§ Database connection initialized, now creating tables if tables not exist...
2026-02-08 20:55:28,497 - core.database - DEBUG - [DB_OP] Starting create_tables
2026-02-08 20:55:28,497 - core.database - INFO - ðŸ”§ Starting table creation...
2026-02-08 20:55:30,055 - core.database - INFO - Tables initialized successfully
2026-02-08 20:55:30,056 - core.database - DEBUG - [DB_OP] Create tables completed in 1.5591s
2026-02-08 20:55:30,117 - services.database - INFO - ðŸ”§ Table creation completed
2026-02-08 20:55:30,117 - services.database - INFO - Database initialized successfully
2026-02-08 20:55:30,118 - services.database - DEBUG - [DB_OP] Database initialization completed in 1.6796s
2026-02-08 20:55:30,120 - services.mock_data - INFO - Processing mock data file state_regulations.json for table state_regulations
2026-02-08 20:55:32,099 - services.mock_data - INFO - Table state_regulations already has 50 rows; skipping mock insert
2026-02-08 20:55:32,159 - services.database - DEBUG - [DB_OP] Starting database initialization
2026-02-08 20:55:32,160 - services.database - INFO - ðŸ”§ Starting database initialization...
2026-02-08 20:55:32,160 - core.database - INFO - Starting database initialization...
2026-02-08 20:55:32,160 - core.database - INFO - Database already initialized
2026-02-08 20:55:32,160 - services.database - INFO - ðŸ”§ Database connection initialized, now creating tables if tables not exist...
2026-02-08 20:55:32,160 - core.database - DEBUG - [DB_OP] Starting create_tables
2026-02-08 20:55:32,160 - core.database - INFO - Tables already initialized
2026-02-08 20:55:32,161 - services.database - INFO - ðŸ”§ Table creation completed
2026-02-08 20:55:32,161 - services.database - INFO - Database initialized successfully
2026-02-08 20:55:32,161 - services.database - DEBUG - [DB_OP] Database initialization completed in 0.0017s
2026-02-08 20:55:32,161 - core.config - DEBUG - Read dynamic attribute admin_user_id from environment variable ADMIN_USER_ID
2026-02-08 20:55:32,162 - core.config - DEBUG - Read dynamic attribute admin_user_email from environment variable ADMIN_USER_EMAIL
2026-02-08 20:55:32,531 - services.auth - DEBUG - Admin user 956410 already exists
2026-02-08 20:55:32,592 - main - INFO - === Application startup completed successfully ===
2026-02-08 20:55:49,289 - core.database - DEBUG - [DB_OP] Starting get_db session creation
2026-02-08 20:55:49,290 - core.database - DEBUG - [DB_OP] Database session created successfully in 0.0007s
2026-02-08 20:55:49,290 - routers.auth - INFO - [token/exchange] Received platform token exchange request
2026-02-08 20:55:49,290 - core.config - DEBUG - Read dynamic attribute oidc_issuer_url from environment variable OIDC_ISSUER_URL
2026-02-08 20:55:49,291 - routers.auth - DEBUG - [token/exchange] Verifying token with issuer: https://auth.atoms.dev/api/v1/oidc/platform/tokens/verify
2026-02-08 20:55:49,993 - httpcore.connection - DEBUG - connect_tcp.started host='auth.atoms.dev' port=443 local_address=None timeout=5.0 socket_options=None
2026-02-08 20:55:50,064 - httpcore.connection - DEBUG - connect_tcp.complete return_value=<httpcore._backends.anyio.AnyIOStream object at 0x7ff374240400>
2026-02-08 20:55:50,064 - httpcore.connection - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x7ff374d8fac0> server_hostname='auth.atoms.dev' timeout=5.0
2026-02-08 20:55:50,072 - httpcore.connection - DEBUG - start_tls.complete return_value=<httpcore._backends.anyio.AnyIOStream object at 0x7ff374241db0>
2026-02-08 20:55:50,073 - httpcore.http11 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2026-02-08 20:55:50,075 - httpcore.http11 - DEBUG - send_request_headers.complete
2026-02-08 20:55:50,075 - httpcore.http11 - DEBUG - send_request_body.started request=<Request [b'POST']>
2026-02-08 20:55:50,076 - httpcore.http11 - DEBUG - send_request_body.complete
2026-02-08 20:55:50,076 - httpcore.http11 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2026-02-08 20:55:50,108 - httpcore.http11 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Mon, 09 Feb 2026 04:55:50 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-response-time', b'0.002s'), (b'x-request-id', b'93c5dc514d9d6b4f2eed14f457af412f'), (b'cf-cache-status', b'DYNAMIC'), (b'Content-Encoding', b'gzip'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9cb0c6d9f8d3d903-LAX')])
2026-02-08 20:55:50,117 - httpx - INFO - HTTP Request: POST https://auth.atoms.dev/api/v1/oidc/platform/tokens/verify "HTTP/1.1 200 OK"
2026-02-08 20:55:50,120 - httpcore.http11 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2026-02-08 20:55:50,124 - httpcore.http11 - DEBUG - receive_response_body.complete
2026-02-08 20:55:50,126 - httpcore.http11 - DEBUG - response_closed.started
2026-02-08 20:55:50,126 - httpcore.http11 - DEBUG - response_closed.complete
2026-02-08 20:55:50,127 - httpcore.connection - DEBUG - close.started
2026-02-08 20:55:50,127 - httpcore.connection - DEBUG - close.complete
2026-02-08 20:55:50,127 - routers.auth - DEBUG - [token/exchange] Issuer response status: 200
2026-02-08 20:55:50,127 - routers.auth - DEBUG - [token/exchange] Issuer response body: {'success': True, 'data': {'exp': 1773200223, 'user_id': 956410, 'email': 'hotogems@gmail.com', 'pv': 0}, 'message': 'Platform token verified', 'code': 0, 'timestamp': '2026-02-09T04:55:50.104236'}
2026-02-08 20:55:50,127 - routers.auth - INFO - [token/exchange] Token verified, platform_user_id=956410, email=hotogems@gmail.com
2026-02-08 20:55:50,128 - routers.auth - INFO - [token/exchange] Admin user verified, issuing admin token without DB persistence
2026-02-08 20:55:50,128 - routers.auth - DEBUG - [token/exchange] Admin user object for token issuance: id=956410, email=hotogems@gmail.com, role=admin
2026-02-08 20:55:50,128 - core.config - DEBUG - Read dynamic attribute jwt_expire_minutes from environment variable JWT_EXPIRE_MINUTES
2026-02-08 20:55:50,129 - core.config - DEBUG - Read dynamic attribute jwt_secret_key from environment variable JWT_SECRET_KEY
2026-02-08 20:55:50,129 - core.config - DEBUG - Read dynamic attribute jwt_algorithm from environment variable JWT_ALGORITHM
2026-02-08 20:55:50,236 - core.auth - DEBUG - Authentication token created for user hash: a89dfb40
2026-02-08 20:55:50,236 - routers.auth - INFO - [token/exchange] Token issued successfully for user_id=956410, expires_at=2026-03-11 04:55:50.128963+00:00
2026-02-08 20:55:50,237 - core.database - DEBUG - [DB_OP] Database session cleanup after 0.9473s
2026-02-08 20:55:50,238 - core.database - DEBUG - [DB_OP] Starting get_db session creation
2026-02-08 20:55:50,238 - core.database - DEBUG - [DB_OP] Database session created successfully in 0.0003s
2026-02-08 20:55:50,239 - routers.auth - INFO - [token/exchange] Received platform token exchange request
2026-02-08 20:55:50,239 - routers.auth - DEBUG - [token/exchange] Verifying token with issuer: https://auth.atoms.dev/api/v1/oidc/platform/tokens/verify
2026-02-08 20:55:50,282 - httpcore.connection - DEBUG - connect_tcp.started host='auth.atoms.dev' port=443 local_address=None timeout=5.0 socket_options=None
2026-02-08 20:55:50,298 - httpcore.connection - DEBUG - connect_tcp.complete return_value=<httpcore._backends.anyio.AnyIOStream object at 0x7ff37700fdf0>
2026-02-08 20:55:50,299 - httpcore.connection - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x7ff3743f7a40> server_hostname='auth.atoms.dev' timeout=5.0
2026-02-08 20:55:50,309 - httpcore.connection - DEBUG - start_tls.complete return_value=<httpcore._backends.anyio.AnyIOStream object at 0x7ff374f06050>
2026-02-08 20:55:50,309 - httpcore.http11 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2026-02-08 20:55:50,310 - httpcore.http11 - DEBUG - send_request_headers.complete
2026-02-08 20:55:50,310 - httpcore.http11 - DEBUG - send_request_body.started request=<Request [b'POST']>
2026-02-08 20:55:50,311 - httpcore.http11 - DEBUG - send_request_body.complete
2026-02-08 20:55:50,311 - httpcore.http11 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2026-02-08 20:55:50,342 - httpcore.http11 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Mon, 09 Feb 2026 04:55:50 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-response-time', b'0.001s'), (b'x-request-id', b'c5ac4f8db09b43171b7f72bb51ab54e1'), (b'cf-cache-status', b'DYNAMIC'), (b'Content-Encoding', b'gzip'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9cb0c6db79aef554-LAX')])
2026-02-08 20:55:50,342 - httpx - INFO - HTTP Request: POST https://auth.atoms.dev/api/v1/oidc/platform/tokens/verify "HTTP/1.1 200 OK"
2026-02-08 20:55:50,343 - httpcore.http11 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2026-02-08 20:55:50,344 - httpcore.http11 - DEBUG - receive_response_body.complete
2026-02-08 20:55:50,344 - httpcore.http11 - DEBUG - response_closed.started
2026-02-08 20:55:50,344 - httpcore.http11 - DEBUG - response_closed.complete
2026-02-08 20:55:50,345 - httpcore.connection - DEBUG - close.started
2026-02-08 20:55:50,345 - httpcore.connection - DEBUG - close.complete
2026-02-08 20:55:50,345 - routers.auth - DEBUG - [token/exchange] Issuer response status: 200
2026-02-08 20:55:50,346 - routers.auth - DEBUG - [token/exchange] Issuer response body: {'success': True, 'data': {'exp': 1773200223, 'user_id': 956410, 'email': 'hotogems@gmail.com', 'pv': 0}, 'message': 'Platform token verified', 'code': 0, 'timestamp': '2026-02-09T04:55:50.339379'}
2026-02-08 20:55:50,346 - routers.auth - INFO - [token/exchange] Token verified, platform_user_id=956410, email=hotogems@gmail.com
2026-02-08 20:55:50,346 - routers.auth - INFO - [token/exchange] Admin user verified, issuing admin token without DB persistence
2026-02-08 20:55:50,347 - routers.auth - DEBUG - [token/exchange] Admin user object for token issuance: id=956410, email=hotogems@gmail.com, role=admin
2026-02-08 20:55:50,348 - core.auth - DEBUG - Authentication token created for user hash: a89dfb40
2026-02-08 20:55:50,348 - routers.auth - INFO - [token/exchange] Token issued successfully for user_id=956410, expires_at=2026-03-11 04:55:50.347855+00:00
2026-02-08 20:55:50,349 - core.database - DEBUG - [DB_OP] Database session cleanup after 0.1109s
2026-02-08 20:56:07,745 - core.auth - DEBUG - Authentication token validated for user hash: a89dfb40
2026-02-08 20:56:08,273 - core.auth - DEBUG - Authentication token validated for user hash: a89dfb40
2026-02-08 20:56:08,273 - core.database - DEBUG - [DB_OP] Starting get_db session creation
2026-02-08 20:56:08,274 - core.database - DEBUG - [DB_OP] Database session created successfully in 0.0003s
2026-02-08 20:56:08,274 - routers.documents - DEBUG - Querying documentss: query=None, sort=-created_at, skip=0, limit=50, fields=None
2026-02-08 20:56:08,777 - routers.documents - DEBUG - Found 10 documentss
2026-02-08 20:56:08,778 - core.database - DEBUG - [DB_OP] Database session cleanup after 0.5046s
2026-02-08 20:56:09,329 - core.auth - DEBUG - Authentication token validated for user hash: a89dfb40
2026-02-08 20:56:09,329 - core.database - DEBUG - [DB_OP] Starting get_db session creation
2026-02-08 20:56:09,329 - core.database - DEBUG - [DB_OP] Database session created successfully in 0.0002s
2026-02-08 20:56:09,694 - core.database - DEBUG - [DB_OP] Database session cleanup after 0.3652s
2026-02-08 20:56:11,542 - core.auth - DEBUG - Authentication token validated for user hash: a89dfb40
2026-02-08 20:56:17,782 - core.auth - DEBUG - Authentication token validated for user hash: a89dfb40
2026-02-08 20:56:17,782 - core.config - DEBUG - Read dynamic attribute oss_service_url from environment variable OSS_SERVICE_URL
2026-02-08 20:56:17,782 - core.config - DEBUG - Read dynamic attribute oss_api_key from environment variable OSS_API_KEY
2026-02-08 20:56:17,813 - httpcore.connection - DEBUG - connect_tcp.started host='atoms.dev' port=443 local_address=None timeout=120.0 socket_options=None
2026-02-08 20:56:17,823 - httpcore.connection - DEBUG - connect_tcp.complete return_value=<httpcore._backends.anyio.AnyIOStream object at 0x7ff3743c7b80>
2026-02-08 20:56:17,824 - httpcore.connection - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x7ff36ffbc540> server_hostname='atoms.dev' timeout=120.0
2026-02-08 20:56:17,833 - httpcore.connection - DEBUG - start_tls.complete return_value=<httpcore._backends.anyio.AnyIOStream object at 0x7ff36fe9e6b0>
2026-02-08 20:56:17,834 - httpcore.http11 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2026-02-08 20:56:17,835 - httpcore.http11 - DEBUG - send_request_headers.complete
2026-02-08 20:56:17,835 - httpcore.http11 - DEBUG - send_request_body.started request=<Request [b'POST']>
2026-02-08 20:56:17,837 - httpcore.http11 - DEBUG - send_request_body.complete
2026-02-08 20:56:17,837 - httpcore.http11 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2026-02-08 20:56:17,875 - httpcore.http11 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Mon, 09 Feb 2026 04:56:17 GMT'), (b'Content-Type', b'application/json; charset=utf-8'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'Access-Control-Allow-Headers', b'Origin, Content-Type, Accept, Authorization'), (b'Access-Control-Allow-Methods', b'GET, POST, PUT, DELETE, OPTIONS'), (b'Access-Control-Allow-Origin', b'*'), (b'Access-Control-Max-Age', b'86400'), (b'X-Request-Id', b'122db33ba42a224cc0f80deb0a42a229'), (b'X-Trace-Id', b'3f2967566a9b4ab0870fab4dc1d888f9'), (b'Content-Security-Policy', b"frame-ancestors 'self' https://atoms.dev"), (b'Strict-Transport-Security', b'max-age=63072000; includeSubDomains; preload'), (b'X-Content-Type-Options', b'nosniff'), (b'X-XSS-Protection', b'1; mode=block'), (b'Referrer-Policy', b'strict-origin-when-cross-origin'), (b'cf-cache-status', b'DYNAMIC'), (b'Content-Encoding', b'gzip'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9cb0c7877c14cb9f-LAX')])
2026-02-08 20:56:17,875 - httpx - INFO - HTTP Request: POST https://atoms.dev/api/v1/infra/client/oss/buckets/lease-documents/objects/upload_url "HTTP/1.1 200 OK"
2026-02-08 20:56:17,876 - httpcore.http11 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2026-02-08 20:56:17,876 - httpcore.http11 - DEBUG - receive_response_body.complete
2026-02-08 20:56:17,876 - httpcore.http11 - DEBUG - response_closed.started
2026-02-08 20:56:17,877 - httpcore.http11 - DEBUG - response_closed.complete
2026-02-08 20:56:17,877 - httpcore.connection - DEBUG - close.started
2026-02-08 20:56:17,877 - httpcore.connection - DEBUG - close.complete
2026-02-08 20:56:23,205 - core.auth - DEBUG - Authentication token validated for user hash: a89dfb40
2026-02-08 20:56:23,205 - core.database - DEBUG - [DB_OP] Starting get_db session creation
2026-02-08 20:56:23,205 - core.database - DEBUG - [DB_OP] Database session created successfully in 0.0002s
2026-02-08 20:56:23,205 - routers.documents - DEBUG - Creating new documents with data: file_name='California-Standard-Residential-Lease-Agreement.pdf' file_key='leases/956410/1770612977858-California-Standard-Residential-Lease-Agreement.pdf' file_size=540804 status='pending' created_at=datetime.datetime(2026, 2, 9, 4, 56, 23, 306000, tzinfo=TzInfo(UTC)) updated_at=datetime.datetime(2026, 2, 9, 4, 56, 23, 306000, tzinfo=TzInfo(UTC))
2026-02-08 20:56:23,996 - services.documents - INFO - Created documents with id: 11
2026-02-08 20:56:23,997 - routers.documents - INFO - Documents created successfully with id: 11
2026-02-08 20:56:23,998 - core.database - DEBUG - [DB_OP] Database session cleanup after 0.7927s
2026-02-08 20:56:24,474 - core.auth - DEBUG - Authentication token validated for user hash: a89dfb40
2026-02-08 20:56:24,474 - core.database - DEBUG - [DB_OP] Starting get_db session creation
2026-02-08 20:56:24,475 - core.database - DEBUG - [DB_OP] Database session created successfully in 0.0003s
2026-02-08 20:56:25,440 - services.documents - INFO - Updated documents 11
2026-02-08 20:56:25,440 - core.config - DEBUG - Read dynamic attribute app_ai_base_url from environment variable APP_AI_BASE_URL
2026-02-08 20:56:25,441 - core.config - DEBUG - Read dynamic attribute app_ai_key from environment variable APP_AI_KEY
2026-02-08 20:56:25,493 - openai._base_client - DEBUG - Request options: {'method': 'post', 'url': '/chat/completions', 'files': None, 'json_data': {'messages': [{'role': 'system', 'content': 'You are a legal document analyzer specializing in residential lease agreements. Always respond with valid JSON only.'}, {'role': 'user', 'content': 'You are an expert lease agreement analyzer. Analyze the following lease document text and extract the key information.\n\nReturn a JSON object with the following fields (use null if not found):\n{\n  "tenant_name": "Full name of the tenant(s)",\n  "landlord_name": "Full name of the landlord/property owner",\n  "property_address": "Complete property address",\n  "monthly_rent": 0.00,\n  "security_deposit": 0.00,\n  "lease_start_date": "YYYY-MM-DD",\n  "lease_end_date": "YYYY-MM-DD",\n  "renewal_notice_days": 30,\n  "pet_policy": "Description of pet policy or \'Not specified\'",\n  "late_fee_terms": "Description of late fee terms or \'Not specified\'",\n  "risk_flags": [\n    {\n      "severity": "high|medium|low",\n      "category": "Category name",\n      "description": "Description of the risk or missing clause"\n    }\n  ]\n}\n\nCommon risk flags to check for:\n1. Missing lead-based paint disclosure (required for pre-1978 buildings)\n2. Missing security deposit return terms\n3. Unclear or missing late fee terms\n4. Missing maintenance responsibility clauses\n5. Missing entry notice requirements\n6. Missing subletting/assignment clauses\n7. Unusual or potentially unfair terms\n8. Missing dispute resolution procedures\n\nIMPORTANT: \n- Extract exact values from the document\n- For dates, convert to YYYY-MM-DD format\n- For monetary values, extract as numbers without currency symbols\n- Identify ALL potential risks and missing standard clauses\n- Return ONLY valid JSON, no additional text\n\nDocument text:\n\n        This is a sample lease agreement for demonstration purposes.\n        The actual PDF content would be extracted here using a PDF parsing service.\n        Document: California-Standard-Residential-Lease-Agreement.pdf\n        '}], 'model': 'gpt-5-chat', 'max_tokens': 4096, 'stream': False, 'temperature': 0.7}}
2026-02-08 20:56:25,494 - httpcore.connection - DEBUG - connect_tcp.started host='llmapi-api.deepwisdom.ai' port=443 local_address=None timeout=5.0 socket_options=None
2026-02-08 20:56:25,512 - httpcore.connection - DEBUG - connect_tcp.complete return_value=<httpcore._backends.anyio.AnyIOStream object at 0x7ff3742c2f80>
2026-02-08 20:56:25,512 - httpcore.connection - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x7ff36ffbce40> server_hostname='llmapi-api.deepwisdom.ai' timeout=5.0
2026-02-08 20:56:25,521 - httpcore.connection - DEBUG - start_tls.complete return_value=<httpcore._backends.anyio.AnyIOStream object at 0x7ff3742c1930>
2026-02-08 20:56:25,522 - httpcore.http11 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2026-02-08 20:56:25,522 - httpcore.http11 - DEBUG - send_request_headers.complete
2026-02-08 20:56:25,522 - httpcore.http11 - DEBUG - send_request_body.started request=<Request [b'POST']>
2026-02-08 20:56:25,523 - httpcore.http11 - DEBUG - send_request_body.complete
2026-02-08 20:56:25,523 - httpcore.http11 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2026-02-08 20:56:29,225 - httpcore.http11 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Mon, 09 Feb 2026 04:56:29 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'Content-Encoding', b'gzip'), (b'Apim-Request-Id', b'e12538ba-3e62-43e6-bb55-109dc79ffbe5'), (b'Azureml-Model-Session', b'd20251215133231-f8b7a15f45ad4fe8'), (b'Strict-Transport-Security', b'max-age=31536000; includeSubDomains; preload'), (b'X-Content-Type-Options', b'nosniff'), (b'X-Ms-Deployment-Name', b'gpt-5-chat'), (b'X-Ms-Rai-Invoked', b'true'), (b'X-Ms-Region', b'Sweden Central'), (b'X-Oneapi-Request-Id', b'2026020820562555792663196970052'), (b'X-Oneapi-Trans-Id', b'19018963375620274'), (b'X-Ratelimit-Limit-Requests', b'5000'), (b'X-Ratelimit-Limit-Tokens', b'5000000'), (b'X-Ratelimit-Remaining-Requests', b'4999'), (b'X-Ratelimit-Remaining-Tokens', b'4999540'), (b'X-Request-Id', b'9c3731ce-ac99-4ad2-92df-7a0334b3155d'), (b'cf-cache-status', b'DYNAMIC'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9cb0c7b78f57de8b-LAX')])
2026-02-08 20:56:29,226 - httpx - INFO - HTTP Request: POST https://llmapi-api.deepwisdom.ai/v1/chat/completions "HTTP/1.1 200 OK"
2026-02-08 20:56:29,227 - httpcore.http11 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2026-02-08 20:56:29,227 - httpcore.http11 - DEBUG - receive_response_body.complete
2026-02-08 20:56:29,227 - httpcore.http11 - DEBUG - response_closed.started
2026-02-08 20:56:29,228 - httpcore.http11 - DEBUG - response_closed.complete
2026-02-08 20:56:29,228 - openai._base_client - DEBUG - HTTP Request: POST https://llmapi-api.deepwisdom.ai/v1/chat/completions "200 OK"
2026-02-08 20:56:29,418 - services.extractions - ERROR - Error creating extractions: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: column "compliance_data" of relation "extractions" does not exist
[SQL: INSERT INTO extractions (user_id, document_id, tenant_name, landlord_name, property_address, monthly_rent, security_deposit, lease_start_date, lease_end_date, renewal_notice_days, pet_policy, late_fee_terms, risk_flags, compliance_data, raw_extraction, created_at) VALUES ($1::VARCHAR, $2::INTEGER, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::FLOAT, $7::FLOAT, $8::VARCHAR, $9::VARCHAR, $10::INTEGER, $11::VARCHAR, $12::VARCHAR, $13::VARCHAR, $14::VARCHAR, $15::VARCHAR, $16::TIMESTAMP WITH TIME ZONE) RETURNING extractions.id]
[parameters: ('956410', 11, None, None, None, None, None, None, None, None, 'Not specified', 'Not specified', "[{'severity': 'high', 'category': 'Missing lead-based paint disclosure', 'description': 'No lead-based paint disclosure found; required for propertie ... (875 characters truncated) ... ategory': 'Missing dispute resolution procedures', 'description': 'No clause describing how disputes between landlord and tenant will be resolved.'}]", "{'state_code': None, 'state_name': None, 'regulations_found': False, 'compliance_checks': [{'category': 'State Identification', 'status': 'warning',  ... (130 characters truncated) ...  is complete.', 'recommendation': 'Ensure the property address includes the state name or abbreviation.'}], 'overall_status': 'state_not_identified'}", "{'tenant_name': None, 'landlord_name': None, 'property_address': None, 'monthly_rent': None, 'security_deposit': None, 'lease_start_date': None, 'lea ... (1154 characters truncated) ... tegory': 'Missing dispute resolution procedures', 'description': 'No clause describing how disputes between landlord and tenant will be resolved.'}]}", datetime.datetime(2026, 2, 8, 20, 56, 29, 234215))]
(Background on this error at: https://sqlalche.me/e/20/f405)
2026-02-08 20:56:29,418 - routers.lease_analysis - ERROR - Analysis error: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: column "compliance_data" of relation "extractions" does not exist
[SQL: INSERT INTO extractions (user_id, document_id, tenant_name, landlord_name, property_address, monthly_rent, security_deposit, lease_start_date, lease_end_date, renewal_notice_days, pet_policy, late_fee_terms, risk_flags, compliance_data, raw_extraction, created_at) VALUES ($1::VARCHAR, $2::INTEGER, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::FLOAT, $7::FLOAT, $8::VARCHAR, $9::VARCHAR, $10::INTEGER, $11::VARCHAR, $12::VARCHAR, $13::VARCHAR, $14::VARCHAR, $15::VARCHAR, $16::TIMESTAMP WITH TIME ZONE) RETURNING extractions.id]
[parameters: ('956410', 11, None, None, None, None, None, None, None, None, 'Not specified', 'Not specified', "[{'severity': 'high', 'category': 'Missing lead-based paint disclosure', 'description': 'No lead-based paint disclosure found; required for propertie ... (875 characters truncated) ... ategory': 'Missing dispute resolution procedures', 'description': 'No clause describing how disputes between landlord and tenant will be resolved.'}]", "{'state_code': None, 'state_name': None, 'regulations_found': False, 'compliance_checks': [{'category': 'State Identification', 'status': 'warning',  ... (130 characters truncated) ...  is complete.', 'recommendation': 'Ensure the property address includes the state name or abbreviation.'}], 'overall_status': 'state_not_identified'}", "{'tenant_name': None, 'landlord_name': None, 'property_address': None, 'monthly_rent': None, 'security_deposit': None, 'lease_start_date': None, 'lea ... (1154 characters truncated) ... tegory': 'Missing dispute resolution procedures', 'description': 'No clause describing how disputes between landlord and tenant will be resolved.'}]}", datetime.datetime(2026, 2, 8, 20, 56, 29, 234215))]
(Background on this error at: https://sqlalche.me/e/20/f405)
2026-02-08 20:56:29,419 - core.database - ERROR - Database session error: 500: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: column "compliance_data" of relation "extractions" does not exist
[SQL: INSERT INTO extractions (user_id, document_id, tenant_name, landlord_name, property_address, monthly_rent, security_deposit, lease_start_date, lease_end_date, renewal_notice_days, pet_policy, late_fee_terms, risk_flags, compliance_data, raw_extraction, created_at) VALUES ($1::VARCHAR, $2::INTEGER, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::FLOAT, $7::FLOAT, $8::VARCHAR, $9::VARCHAR, $10::INTEGER, $11::VARCHAR, $12::VARCHAR, $13::VARCHAR, $14::VARCHAR, $15::VARCHAR, $16::TIMESTAMP WITH TIME ZONE) RETURNING extractions.id]
[parameters: ('956410', 11, None, None, None, None, None, None, None, None, 'Not specified', 'Not specified', "[{'severity': 'high', 'category': 'Missing lead-based paint disclosure', 'description': 'No lead-based paint disclosure found; required for propertie ... (875 characters truncated) ... ategory': 'Missing dispute resolution procedures', 'description': 'No clause describing how disputes between landlord and tenant will be resolved.'}]", "{'state_code': None, 'state_name': None, 'regulations_found': False, 'compliance_checks': [{'category': 'State Identification', 'status': 'warning',  ... (130 characters truncated) ...  is complete.', 'recommendation': 'Ensure the property address includes the state name or abbreviation.'}], 'overall_status': 'state_not_identified'}", "{'tenant_name': None, 'landlord_name': None, 'property_address': None, 'monthly_rent': None, 'security_deposit': None, 'lease_start_date': None, 'lea ... (1154 characters truncated) ... tegory': 'Missing dispute resolution procedures', 'description': 'No clause describing how disputes between landlord and tenant will be resolved.'}]}", datetime.datetime(2026, 2, 8, 20, 56, 29, 234215))]
(Background on this error at: https://sqlalche.me/e/20/f405)
Traceback (most recent call last):
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 526, in _prepare_and_execute
    prepared_stmt, attributes = await adapt_connection._prepare(
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 773, in _prepare
    prepared_stmt = await self._connection.prepare(
  File "/data/.cache/python/lib/python3.10/site-packages/asyncpg/connection.py", line 638, in prepare
    return await self._prepare(
  File "/data/.cache/python/lib/python3.10/site-packages/asyncpg/connection.py", line 657, in _prepare
    stmt = await self._get_statement(
  File "/data/.cache/python/lib/python3.10/site-packages/asyncpg/connection.py", line 443, in _get_statement
    statement = await self._protocol.prepare(
  File "asyncpg/protocol/protocol.pyx", line 165, in prepare
asyncpg.exceptions.UndefinedColumnError: column "compliance_data" of relation "extractions" does not exist

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 952, in do_execute
    cursor.execute(statement, parameters)
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 585, in execute
    self._adapt_connection.await_(
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 563, in _prepare_and_execute
    self._handle_exception(error)
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 513, in _handle_exception
    self._adapt_connection._handle_exception(error)
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 797, in _handle_exception
    raise translated_error from error
sqlalchemy.dialects.postgresql.asyncpg.AsyncAdapt_asyncpg_dbapi.ProgrammingError: <class 'asyncpg.exceptions.UndefinedColumnError'>: column "compliance_data" of relation "extractions" does not exist

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/workspace/app/backend/routers/lease_analysis.py", line 127, in analyze_document
    extraction = await extractions_service.create({
  File "/workspace/app/backend/services/extractions.py", line 26, in create
    await self.db.commit()
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/ext/asyncio/session.py", line 1000, in commit
    await greenlet_spawn(self.sync_session.commit)
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2030, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/orm/state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 1311, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/orm/state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 1286, in _prepare_impl
    self.session.flush()
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 4331, in flush
    self._flush(objects)
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 4466, in _flush
    with util.safe_reraise():
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 4427, in _flush
    flush_context.execute()
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1419, in execute
    return meth(
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/sql/elements.py", line 527, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1846, in _execute_context
    return self._exec_single_context(
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2363, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 952, in do_execute
    cursor.execute(statement, parameters)
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 585, in execute
    self._adapt_connection.await_(
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 563, in _prepare_and_execute
    self._handle_exception(error)
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 513, in _handle_exception
    self._adapt_connection._handle_exception(error)
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 797, in _handle_exception
    raise translated_error from error
sqlalchemy.exc.ProgrammingError: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: column "compliance_data" of relation "extractions" does not exist
[SQL: INSERT INTO extractions (user_id, document_id, tenant_name, landlord_name, property_address, monthly_rent, security_deposit, lease_start_date, lease_end_date, renewal_notice_days, pet_policy, late_fee_terms, risk_flags, compliance_data, raw_extraction, created_at) VALUES ($1::VARCHAR, $2::INTEGER, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::FLOAT, $7::FLOAT, $8::VARCHAR, $9::VARCHAR, $10::INTEGER, $11::VARCHAR, $12::VARCHAR, $13::VARCHAR, $14::VARCHAR, $15::VARCHAR, $16::TIMESTAMP WITH TIME ZONE) RETURNING extractions.id]
[parameters: ('956410', 11, None, None, None, None, None, None, None, None, 'Not specified', 'Not specified', "[{'severity': 'high', 'category': 'Missing lead-based paint disclosure', 'description': 'No lead-based paint disclosure found; required for propertie ... (875 characters truncated) ... ategory': 'Missing dispute resolution procedures', 'description': 'No clause describing how disputes between landlord and tenant will be resolved.'}]", "{'state_code': None, 'state_name': None, 'regulations_found': False, 'compliance_checks': [{'category': 'State Identification', 'status': 'warning',  ... (130 characters truncated) ...  is complete.', 'recommendation': 'Ensure the property address includes the state name or abbreviation.'}], 'overall_status': 'state_not_identified'}", "{'tenant_name': None, 'landlord_name': None, 'property_address': None, 'monthly_rent': None, 'security_deposit': None, 'lease_start_date': None, 'lea ... (1154 characters truncated) ... tegory': 'Missing dispute resolution procedures', 'description': 'No clause describing how disputes between landlord and tenant will be resolved.'}]}", datetime.datetime(2026, 2, 8, 20, 56, 29, 234215))]
(Background on this error at: https://sqlalche.me/e/20/f405)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/workspace/app/backend/core/database.py", line 534, in get_db
    yield session
  File "/data/.cache/python/lib/python3.10/site-packages/fastapi/routing.py", line 107, in app
    response = await f(request)
  File "/data/.cache/python/lib/python3.10/site-packages/fastapi/routing.py", line 426, in app
    raw_response = await run_endpoint_function(
  File "/data/.cache/python/lib/python3.10/site-packages/fastapi/routing.py", line 314, in run_endpoint_function
    return await dependant.call(**values)
  File "/workspace/app/backend/routers/lease_analysis.py", line 172, in analyze_document
    raise HTTPException(status_code=500, detail=str(e))
fastapi.exceptions.HTTPException: 500: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: column "compliance_data" of relation "extractions" does not exist
[SQL: INSERT INTO extractions (user_id, document_id, tenant_name, landlord_name, property_address, monthly_rent, security_deposit, lease_start_date, lease_end_date, renewal_notice_days, pet_policy, late_fee_terms, risk_flags, compliance_data, raw_extraction, created_at) VALUES ($1::VARCHAR, $2::INTEGER, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::FLOAT, $7::FLOAT, $8::VARCHAR, $9::VARCHAR, $10::INTEGER, $11::VARCHAR, $12::VARCHAR, $13::VARCHAR, $14::VARCHAR, $15::VARCHAR, $16::TIMESTAMP WITH TIME ZONE) RETURNING extractions.id]
[parameters: ('956410', 11, None, None, None, None, None, None, None, None, 'Not specified', 'Not specified', "[{'severity': 'high', 'category': 'Missing lead-based paint disclosure', 'description': 'No lead-based paint disclosure found; required for propertie ... (875 characters truncated) ... ategory': 'Missing dispute resolution procedures', 'description': 'No clause describing how disputes between landlord and tenant will be resolved.'}]", "{'state_code': None, 'state_name': None, 'regulations_found': False, 'compliance_checks': [{'category': 'State Identification', 'status': 'warning',  ... (130 characters truncated) ...  is complete.', 'recommendation': 'Ensure the property address includes the state name or abbreviation.'}], 'overall_status': 'state_not_identified'}", "{'tenant_name': None, 'landlord_name': None, 'property_address': None, 'monthly_rent': None, 'security_deposit': None, 'lease_start_date': None, 'lea ... (1154 characters truncated) ... tegory': 'Missing dispute resolution procedures', 'description': 'No clause describing how disputes between landlord and tenant will be resolved.'}]}", datetime.datetime(2026, 2, 8, 20, 56, 29, 234215))]
(Background on this error at: https://sqlalche.me/e/20/f405)
2026-02-08 20:56:29,491 - core.database - DEBUG - [DB_OP] Database session cleanup after 5.0167s
2026-02-08 20:56:29,491 - core.database - ERROR - Failed to create database session: 500: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: column "compliance_data" of relation "extractions" does not exist
[SQL: INSERT INTO extractions (user_id, document_id, tenant_name, landlord_name, property_address, monthly_rent, security_deposit, lease_start_date, lease_end_date, renewal_notice_days, pet_policy, late_fee_terms, risk_flags, compliance_data, raw_extraction, created_at) VALUES ($1::VARCHAR, $2::INTEGER, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::FLOAT, $7::FLOAT, $8::VARCHAR, $9::VARCHAR, $10::INTEGER, $11::VARCHAR, $12::VARCHAR, $13::VARCHAR, $14::VARCHAR, $15::VARCHAR, $16::TIMESTAMP WITH TIME ZONE) RETURNING extractions.id]
[parameters: ('956410', 11, None, None, None, None, None, None, None, None, 'Not specified', 'Not specified', "[{'severity': 'high', 'category': 'Missing lead-based paint disclosure', 'description': 'No lead-based paint disclosure found; required for propertie ... (875 characters truncated) ... ategory': 'Missing dispute resolution procedures', 'description': 'No clause describing how disputes between landlord and tenant will be resolved.'}]", "{'state_code': None, 'state_name': None, 'regulations_found': False, 'compliance_checks': [{'category': 'State Identification', 'status': 'warning',  ... (130 characters truncated) ...  is complete.', 'recommendation': 'Ensure the property address includes the state name or abbreviation.'}], 'overall_status': 'state_not_identified'}", "{'tenant_name': None, 'landlord_name': None, 'property_address': None, 'monthly_rent': None, 'security_deposit': None, 'lease_start_date': None, 'lea ... (1154 characters truncated) ... tegory': 'Missing dispute resolution procedures', 'description': 'No clause describing how disputes between landlord and tenant will be resolved.'}]}", datetime.datetime(2026, 2, 8, 20, 56, 29, 234215))]
(Background on this error at: https://sqlalche.me/e/20/f405)
Traceback (most recent call last):
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 526, in _prepare_and_execute
    prepared_stmt, attributes = await adapt_connection._prepare(
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 773, in _prepare
    prepared_stmt = await self._connection.prepare(
  File "/data/.cache/python/lib/python3.10/site-packages/asyncpg/connection.py", line 638, in prepare
    return await self._prepare(
  File "/data/.cache/python/lib/python3.10/site-packages/asyncpg/connection.py", line 657, in _prepare
    stmt = await self._get_statement(
  File "/data/.cache/python/lib/python3.10/site-packages/asyncpg/connection.py", line 443, in _get_statement
    statement = await self._protocol.prepare(
  File "asyncpg/protocol/protocol.pyx", line 165, in prepare
asyncpg.exceptions.UndefinedColumnError: column "compliance_data" of relation "extractions" does not exist

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 952, in do_execute
    cursor.execute(statement, parameters)
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 585, in execute
    self._adapt_connection.await_(
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 563, in _prepare_and_execute
    self._handle_exception(error)
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 513, in _handle_exception
    self._adapt_connection._handle_exception(error)
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 797, in _handle_exception
    raise translated_error from error
sqlalchemy.dialects.postgresql.asyncpg.AsyncAdapt_asyncpg_dbapi.ProgrammingError: <class 'asyncpg.exceptions.UndefinedColumnError'>: column "compliance_data" of relation "extractions" does not exist

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/workspace/app/backend/routers/lease_analysis.py", line 127, in analyze_document
    extraction = await extractions_service.create({
  File "/workspace/app/backend/services/extractions.py", line 26, in create
    await self.db.commit()
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/ext/asyncio/session.py", line 1000, in commit
    await greenlet_spawn(self.sync_session.commit)
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2030, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/orm/state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 1311, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/orm/state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 1286, in _prepare_impl
    self.session.flush()
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 4331, in flush
    self._flush(objects)
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 4466, in _flush
    with util.safe_reraise():
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 4427, in _flush
    flush_context.execute()
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1419, in execute
    return meth(
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/sql/elements.py", line 527, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1846, in _execute_context
    return self._exec_single_context(
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2363, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 952, in do_execute
    cursor.execute(statement, parameters)
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 585, in execute
    self._adapt_connection.await_(
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 563, in _prepare_and_execute
    self._handle_exception(error)
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 513, in _handle_exception
    self._adapt_connection._handle_exception(error)
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 797, in _handle_exception
    raise translated_error from error
sqlalchemy.exc.ProgrammingError: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: column "compliance_data" of relation "extractions" does not exist
[SQL: INSERT INTO extractions (user_id, document_id, tenant_name, landlord_name, property_address, monthly_rent, security_deposit, lease_start_date, lease_end_date, renewal_notice_days, pet_policy, late_fee_terms, risk_flags, compliance_data, raw_extraction, created_at) VALUES ($1::VARCHAR, $2::INTEGER, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::FLOAT, $7::FLOAT, $8::VARCHAR, $9::VARCHAR, $10::INTEGER, $11::VARCHAR, $12::VARCHAR, $13::VARCHAR, $14::VARCHAR, $15::VARCHAR, $16::TIMESTAMP WITH TIME ZONE) RETURNING extractions.id]
[parameters: ('956410', 11, None, None, None, None, None, None, None, None, 'Not specified', 'Not specified', "[{'severity': 'high', 'category': 'Missing lead-based paint disclosure', 'description': 'No lead-based paint disclosure found; required for propertie ... (875 characters truncated) ... ategory': 'Missing dispute resolution procedures', 'description': 'No clause describing how disputes between landlord and tenant will be resolved.'}]", "{'state_code': None, 'state_name': None, 'regulations_found': False, 'compliance_checks': [{'category': 'State Identification', 'status': 'warning',  ... (130 characters truncated) ...  is complete.', 'recommendation': 'Ensure the property address includes the state name or abbreviation.'}], 'overall_status': 'state_not_identified'}", "{'tenant_name': None, 'landlord_name': None, 'property_address': None, 'monthly_rent': None, 'security_deposit': None, 'lease_start_date': None, 'lea ... (1154 characters truncated) ... tegory': 'Missing dispute resolution procedures', 'description': 'No clause describing how disputes between landlord and tenant will be resolved.'}]}", datetime.datetime(2026, 2, 8, 20, 56, 29, 234215))]
(Background on this error at: https://sqlalche.me/e/20/f405)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/workspace/app/backend/core/database.py", line 534, in get_db
    yield session
  File "/data/.cache/python/lib/python3.10/site-packages/fastapi/routing.py", line 107, in app
    response = await f(request)
  File "/data/.cache/python/lib/python3.10/site-packages/fastapi/routing.py", line 426, in app
    raw_response = await run_endpoint_function(
  File "/data/.cache/python/lib/python3.10/site-packages/fastapi/routing.py", line 314, in run_endpoint_function
    return await dependant.call(**values)
  File "/workspace/app/backend/routers/lease_analysis.py", line 172, in analyze_document
    raise HTTPException(status_code=500, detail=str(e))
fastapi.exceptions.HTTPException: 500: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: column "compliance_data" of relation "extractions" does not exist
[SQL: INSERT INTO extractions (user_id, document_id, tenant_name, landlord_name, property_address, monthly_rent, security_deposit, lease_start_date, lease_end_date, renewal_notice_days, pet_policy, late_fee_terms, risk_flags, compliance_data, raw_extraction, created_at) VALUES ($1::VARCHAR, $2::INTEGER, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::FLOAT, $7::FLOAT, $8::VARCHAR, $9::VARCHAR, $10::INTEGER, $11::VARCHAR, $12::VARCHAR, $13::VARCHAR, $14::VARCHAR, $15::VARCHAR, $16::TIMESTAMP WITH TIME ZONE) RETURNING extractions.id]
[parameters: ('956410', 11, None, None, None, None, None, None, None, None, 'Not specified', 'Not specified', "[{'severity': 'high', 'category': 'Missing lead-based paint disclosure', 'description': 'No lead-based paint disclosure found; required for propertie ... (875 characters truncated) ... ategory': 'Missing dispute resolution procedures', 'description': 'No clause describing how disputes between landlord and tenant will be resolved.'}]", "{'state_code': None, 'state_name': None, 'regulations_found': False, 'compliance_checks': [{'category': 'State Identification', 'status': 'warning',  ... (130 characters truncated) ...  is complete.', 'recommendation': 'Ensure the property address includes the state name or abbreviation.'}], 'overall_status': 'state_not_identified'}", "{'tenant_name': None, 'landlord_name': None, 'property_address': None, 'monthly_rent': None, 'security_deposit': None, 'lease_start_date': None, 'lea ... (1154 characters truncated) ... tegory': 'Missing dispute resolution procedures', 'description': 'No clause describing how disputes between landlord and tenant will be resolved.'}]}", datetime.datetime(2026, 2, 8, 20, 56, 29, 234215))]
(Background on this error at: https://sqlalche.me/e/20/f405)
2026-02-08 20:58:17,334 - services.database - DEBUG - [DB_OP] Starting database close
2026-02-08 20:58:17,397 - core.database - INFO - Database connection closed and engine disposed
2026-02-08 20:58:17,398 - services.database - INFO - Database connections closed
2026-02-08 20:58:17,398 - services.database - DEBUG - [DB_OP] Database close completed in 0.0644s
