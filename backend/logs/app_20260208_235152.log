2026-02-08 23:51:52,937 - main - INFO - === Logging system initialized ===
2026-02-08 23:51:52,937 - main - INFO - Log file: logs/app_20260208_235152.log
2026-02-08 23:51:52,937 - main - INFO - Log level: INFO
2026-02-08 23:51:52,938 - main - INFO - Timestamp: 20260208_235152
2026-02-08 23:51:53,445 - main - INFO - Included router: routers.aihub.router
2026-02-08 23:51:53,461 - main - INFO - Included router: routers.auth.router
2026-02-08 23:51:53,505 - main - INFO - Included router: routers.documents.router
2026-02-08 23:51:53,558 - main - INFO - Included router: routers.extractions.router
2026-02-08 23:51:53,564 - main - INFO - Included router: routers.google_auth.router
2026-02-08 23:51:53,565 - main - INFO - Included router: routers.health.router
2026-02-08 23:51:53,791 - main - INFO - Included router: routers.lease_analysis.router
2026-02-08 23:51:53,836 - main - INFO - Included router: routers.payments.router
2026-02-08 23:51:53,856 - main - INFO - Included router: routers.settings.router
2026-02-08 23:51:53,894 - main - INFO - Included router: routers.state_regulations.router
2026-02-08 23:51:53,916 - main - INFO - Included router: routers.storage.router
2026-02-08 23:51:53,935 - core.config - DEBUG - Read dynamic attribute stripe_secret_key from environment variable STRIPE_SECRET_KEY
2026-02-08 23:51:53,948 - main - INFO - Included router: routers.stripe_payments.router
2026-02-08 23:51:53,956 - main - INFO - Included router: routers.user.router
2026-02-08 23:51:54,092 - main - INFO - Included router: routers.user_credits.router
2026-02-08 23:51:54,093 - main - INFO - === Application startup initiated ===
2026-02-08 23:51:54,093 - services.database - DEBUG - [DB_OP] Starting database initialization
2026-02-08 23:51:54,094 - services.database - INFO - üîß Starting database initialization...
2026-02-08 23:51:54,094 - core.database - INFO - Starting database initialization...
2026-02-08 23:51:54,094 - core.config - DEBUG - Read dynamic attribute database_url from environment variable DATABASE_URL
2026-02-08 23:51:54,094 - core.database - INFO - Normalizing database URL for async compatibility...
2026-02-08 23:51:54,095 - core.database - INFO - Creating async database engine...
2026-02-08 23:51:54,095 - core.database - INFO - Using QueuePool with connection pooling for non-Lambda environment
2026-02-08 23:51:54,135 - core.database - INFO - Database engine created successfully
2026-02-08 23:51:54,136 - core.database - INFO - Creating async session maker...
2026-02-08 23:51:54,136 - core.database - INFO - Async session maker created successfully
2026-02-08 23:51:54,136 - core.database - INFO - Database connection initialized successfully
2026-02-08 23:51:54,136 - services.database - INFO - üîß Database connection initialized, now creating tables if tables not exist...
2026-02-08 23:51:54,136 - core.database - DEBUG - [DB_OP] Starting create_tables
2026-02-08 23:51:54,136 - core.database - INFO - üîß Starting table creation...
2026-02-08 23:51:55,819 - core.database - INFO - Tables initialized successfully
2026-02-08 23:51:55,820 - core.database - DEBUG - [DB_OP] Create tables completed in 1.6833s
2026-02-08 23:51:55,885 - services.database - INFO - üîß Table creation completed
2026-02-08 23:51:55,885 - services.database - INFO - Database initialized successfully
2026-02-08 23:51:55,886 - services.database - DEBUG - [DB_OP] Database initialization completed in 1.7921s
2026-02-08 23:51:55,886 - services.mock_data - INFO - Processing mock data file state_regulations.json for table state_regulations
2026-02-08 23:51:58,018 - services.mock_data - INFO - Table state_regulations already has 50 rows; skipping mock insert
2026-02-08 23:51:58,083 - services.database - DEBUG - [DB_OP] Starting database initialization
2026-02-08 23:51:58,083 - services.database - INFO - üîß Starting database initialization...
2026-02-08 23:51:58,084 - core.database - INFO - Starting database initialization...
2026-02-08 23:51:58,084 - core.database - INFO - Database already initialized
2026-02-08 23:51:58,084 - services.database - INFO - üîß Database connection initialized, now creating tables if tables not exist...
2026-02-08 23:51:58,085 - core.database - DEBUG - [DB_OP] Starting create_tables
2026-02-08 23:51:58,085 - core.database - INFO - Tables already initialized
2026-02-08 23:51:58,085 - services.database - INFO - üîß Table creation completed
2026-02-08 23:51:58,085 - services.database - INFO - Database initialized successfully
2026-02-08 23:51:58,086 - services.database - DEBUG - [DB_OP] Database initialization completed in 0.0023s
2026-02-08 23:51:58,086 - core.config - DEBUG - Read dynamic attribute admin_user_id from environment variable ADMIN_USER_ID
2026-02-08 23:51:58,086 - core.config - DEBUG - Read dynamic attribute admin_user_email from environment variable ADMIN_USER_EMAIL
2026-02-08 23:51:58,483 - services.auth - DEBUG - Admin user 956410 already exists
2026-02-08 23:51:58,548 - main - INFO - === Application startup completed successfully ===
2026-02-09 00:04:59,110 - core.config - DEBUG - Read dynamic attribute jwt_secret_key from environment variable JWT_SECRET_KEY
2026-02-09 00:04:59,111 - core.config - DEBUG - Read dynamic attribute jwt_algorithm from environment variable JWT_ALGORITHM
2026-02-09 00:04:59,257 - core.auth - DEBUG - Authentication token validated for user hash: a89dfb40
2026-02-09 00:04:59,693 - core.auth - DEBUG - Authentication token validated for user hash: a89dfb40
2026-02-09 00:04:59,693 - core.database - DEBUG - [DB_OP] Starting get_db session creation
2026-02-09 00:04:59,693 - core.database - DEBUG - [DB_OP] Database session created successfully in 0.0002s
2026-02-09 00:04:59,693 - routers.documents - DEBUG - Querying documentss: query=None, sort=-created_at, skip=0, limit=50, fields=None
2026-02-09 00:05:00,819 - routers.documents - DEBUG - Found 14 documentss
2026-02-09 00:05:00,820 - core.database - DEBUG - [DB_OP] Database session cleanup after 1.1272s
2026-02-09 00:05:01,293 - core.auth - DEBUG - Authentication token validated for user hash: a89dfb40
2026-02-09 00:05:01,294 - core.database - DEBUG - [DB_OP] Starting get_db session creation
2026-02-09 00:05:01,294 - core.database - DEBUG - [DB_OP] Database session created successfully in 0.0004s
2026-02-09 00:05:01,715 - core.database - DEBUG - [DB_OP] Database session cleanup after 0.4216s
2026-02-09 00:05:05,044 - core.auth - DEBUG - Authentication token validated for user hash: a89dfb40
2026-02-09 00:05:05,461 - core.auth - DEBUG - Authentication token validated for user hash: a89dfb40
2026-02-09 00:05:05,461 - core.database - DEBUG - [DB_OP] Starting get_db session creation
2026-02-09 00:05:05,461 - core.database - DEBUG - [DB_OP] Database session created successfully in 0.0003s
2026-02-09 00:05:05,761 - core.database - DEBUG - [DB_OP] Database session cleanup after 0.2994s
2026-02-09 00:05:09,614 - core.auth - DEBUG - Authentication token validated for user hash: a89dfb40
2026-02-09 00:05:09,614 - core.config - DEBUG - Read dynamic attribute oss_service_url from environment variable OSS_SERVICE_URL
2026-02-09 00:05:09,614 - core.config - DEBUG - Read dynamic attribute oss_api_key from environment variable OSS_API_KEY
2026-02-09 00:05:11,024 - httpcore.connection - DEBUG - connect_tcp.started host='atoms.dev' port=443 local_address=None timeout=120.0 socket_options=None
2026-02-09 00:05:11,036 - httpcore.connection - DEBUG - connect_tcp.complete return_value=<httpcore._backends.anyio.AnyIOStream object at 0x7f04f82a6f50>
2026-02-09 00:05:11,037 - httpcore.connection - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x7f04f824b6c0> server_hostname='atoms.dev' timeout=120.0
2026-02-09 00:05:11,045 - httpcore.connection - DEBUG - start_tls.complete return_value=<httpcore._backends.anyio.AnyIOStream object at 0x7f04f8afcee0>
2026-02-09 00:05:11,045 - httpcore.http11 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2026-02-09 00:05:11,046 - httpcore.http11 - DEBUG - send_request_headers.complete
2026-02-09 00:05:11,046 - httpcore.http11 - DEBUG - send_request_body.started request=<Request [b'POST']>
2026-02-09 00:05:11,046 - httpcore.http11 - DEBUG - send_request_body.complete
2026-02-09 00:05:11,046 - httpcore.http11 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2026-02-09 00:05:11,078 - httpcore.http11 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Mon, 09 Feb 2026 08:05:11 GMT'), (b'Content-Type', b'application/json; charset=utf-8'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'Access-Control-Allow-Headers', b'Origin, Content-Type, Accept, Authorization'), (b'Access-Control-Allow-Methods', b'GET, POST, PUT, DELETE, OPTIONS'), (b'Access-Control-Allow-Origin', b'*'), (b'Access-Control-Max-Age', b'86400'), (b'X-Request-Id', b'2cea3da42b7977adca39d41f121932f1'), (b'X-Trace-Id', b'4255e10b0cf046ebbc4d5127859e3c07'), (b'Content-Security-Policy', b"frame-ancestors 'self' https://atoms.dev"), (b'Strict-Transport-Security', b'max-age=63072000; includeSubDomains; preload'), (b'X-Content-Type-Options', b'nosniff'), (b'X-XSS-Protection', b'1; mode=block'), (b'Referrer-Policy', b'strict-origin-when-cross-origin'), (b'cf-cache-status', b'DYNAMIC'), (b'Content-Encoding', b'gzip'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9cb1dc3808491289-LAX')])
2026-02-09 00:05:11,079 - httpx - INFO - HTTP Request: POST https://atoms.dev/api/v1/infra/client/oss/buckets/lease-documents/objects/upload_url "HTTP/1.1 200 OK"
2026-02-09 00:05:11,079 - httpcore.http11 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2026-02-09 00:05:11,080 - httpcore.http11 - DEBUG - receive_response_body.complete
2026-02-09 00:05:11,080 - httpcore.http11 - DEBUG - response_closed.started
2026-02-09 00:05:11,080 - httpcore.http11 - DEBUG - response_closed.complete
2026-02-09 00:05:11,081 - httpcore.connection - DEBUG - close.started
2026-02-09 00:05:11,081 - httpcore.connection - DEBUG - close.complete
2026-02-09 00:05:14,695 - core.auth - DEBUG - Authentication token validated for user hash: a89dfb40
2026-02-09 00:05:14,695 - core.database - DEBUG - [DB_OP] Starting get_db session creation
2026-02-09 00:05:14,695 - core.database - DEBUG - [DB_OP] Database session created successfully in 0.0002s
2026-02-09 00:05:14,696 - routers.documents - DEBUG - Creating new documents with data: file_name='California_Residential_Lease_Agreement.pdf' file_key='leases/956410/1770624309735-California_Residential_Lease_Agreement.pdf' file_size=79715 status='pending' created_at=datetime.datetime(2026, 2, 9, 8, 5, 14, 914000, tzinfo=TzInfo(UTC)) updated_at=datetime.datetime(2026, 2, 9, 8, 5, 14, 914000, tzinfo=TzInfo(UTC))
2026-02-09 00:05:15,484 - services.documents - INFO - Created documents with id: 15
2026-02-09 00:05:15,484 - routers.documents - INFO - Documents created successfully with id: 15
2026-02-09 00:05:15,485 - core.database - DEBUG - [DB_OP] Database session cleanup after 0.7896s
2026-02-09 00:05:15,979 - core.auth - DEBUG - Authentication token validated for user hash: a89dfb40
2026-02-09 00:05:15,980 - core.database - DEBUG - [DB_OP] Starting get_db session creation
2026-02-09 00:05:15,980 - core.database - DEBUG - [DB_OP] Database session created successfully in 0.0005s
2026-02-09 00:05:16,939 - services.documents - INFO - Updated documents 15
2026-02-09 00:05:16,990 - httpcore.connection - DEBUG - connect_tcp.started host='atoms.dev' port=443 local_address=None timeout=120.0 socket_options=None
2026-02-09 00:05:16,999 - httpcore.connection - DEBUG - connect_tcp.complete return_value=<httpcore._backends.anyio.AnyIOStream object at 0x7f04f82a78b0>
2026-02-09 00:05:16,999 - httpcore.connection - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x7f04ebe7c6c0> server_hostname='atoms.dev' timeout=120.0
2026-02-09 00:05:17,007 - httpcore.connection - DEBUG - start_tls.complete return_value=<httpcore._backends.anyio.AnyIOStream object at 0x7f04f82a72b0>
2026-02-09 00:05:17,008 - httpcore.http11 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2026-02-09 00:05:17,008 - httpcore.http11 - DEBUG - send_request_headers.complete
2026-02-09 00:05:17,008 - httpcore.http11 - DEBUG - send_request_body.started request=<Request [b'POST']>
2026-02-09 00:05:17,009 - httpcore.http11 - DEBUG - send_request_body.complete
2026-02-09 00:05:17,010 - httpcore.http11 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2026-02-09 00:05:17,039 - httpcore.http11 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Mon, 09 Feb 2026 08:05:17 GMT'), (b'Content-Type', b'application/json; charset=utf-8'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'Access-Control-Allow-Headers', b'Origin, Content-Type, Accept, Authorization'), (b'Access-Control-Allow-Methods', b'GET, POST, PUT, DELETE, OPTIONS'), (b'Access-Control-Allow-Origin', b'*'), (b'Access-Control-Max-Age', b'86400'), (b'X-Request-Id', b'cacd7f8391582b232f8150e460816245'), (b'X-Trace-Id', b'1988dddb5d1e44a5b621f43d68e56a42'), (b'Content-Security-Policy', b"frame-ancestors 'self' https://atoms.dev"), (b'Strict-Transport-Security', b'max-age=63072000; includeSubDomains; preload'), (b'X-Content-Type-Options', b'nosniff'), (b'X-XSS-Protection', b'1; mode=block'), (b'Referrer-Policy', b'strict-origin-when-cross-origin'), (b'cf-cache-status', b'DYNAMIC'), (b'Content-Encoding', b'gzip'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9cb1dc5d4d91cb8e-LAX')])
2026-02-09 00:05:17,039 - httpx - INFO - HTTP Request: POST https://atoms.dev/api/v1/infra/client/oss/buckets/lease-documents/objects/download_url "HTTP/1.1 200 OK"
2026-02-09 00:05:17,040 - httpcore.http11 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2026-02-09 00:05:17,040 - httpcore.http11 - DEBUG - receive_response_body.complete
2026-02-09 00:05:17,040 - httpcore.http11 - DEBUG - response_closed.started
2026-02-09 00:05:17,040 - httpcore.http11 - DEBUG - response_closed.complete
2026-02-09 00:05:17,041 - httpcore.connection - DEBUG - close.started
2026-02-09 00:05:17,041 - httpcore.connection - DEBUG - close.complete
2026-02-09 00:05:17,065 - httpcore.connection - DEBUG - connect_tcp.started host='ec703bc455e9fe085c3fab7a4c274a50.oss.atoms.dev' port=443 local_address=None timeout=120.0 socket_options=None
2026-02-09 00:05:17,082 - httpcore.connection - DEBUG - connect_tcp.complete return_value=<httpcore._backends.anyio.AnyIOStream object at 0x7f04ebfa4b50>
2026-02-09 00:05:17,082 - httpcore.connection - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x7f04ebe7cc40> server_hostname='ec703bc455e9fe085c3fab7a4c274a50.oss.atoms.dev' timeout=120.0
2026-02-09 00:05:17,089 - httpcore.connection - DEBUG - start_tls.complete return_value=<httpcore._backends.anyio.AnyIOStream object at 0x7f04ebfa4700>
2026-02-09 00:05:17,090 - httpcore.http11 - DEBUG - send_request_headers.started request=<Request [b'GET']>
2026-02-09 00:05:17,090 - httpcore.http11 - DEBUG - send_request_headers.complete
2026-02-09 00:05:17,090 - httpcore.http11 - DEBUG - send_request_body.started request=<Request [b'GET']>
2026-02-09 00:05:17,091 - httpcore.http11 - DEBUG - send_request_body.complete
2026-02-09 00:05:17,091 - httpcore.http11 - DEBUG - receive_response_headers.started request=<Request [b'GET']>
2026-02-09 00:05:17,400 - httpcore.http11 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Mon, 09 Feb 2026 08:05:17 GMT'), (b'Content-Type', b'application/pdf'), (b'Content-Length', b'79715'), (b'Connection', b'keep-alive'), (b'CF-Ray', b'9cb1dc5ddf07f206-LAX'), (b'Accept-Ranges', b'bytes'), (b'Access-Control-Allow-Origin', b'*'), (b'ETag', b'"9f762a6082d2700a1a0dd7f27debbafe"'), (b'Last-Modified', b'Mon, 09 Feb 2026 08:05:14 GMT'), (b'Server', b'cloudflare'), (b'Access-Control-Allow-Headers', b'*'), (b'Access-Control-Allow-Methods', b'GET, HEAD, PUT, POST, DELETE, OPTIONS'), (b'Access-Control-Expose-Headers', b'ETag, Content-Length, Content-Type'), (b'Access-Control-Max-Age', b'86400')])
2026-02-09 00:05:17,401 - httpx - INFO - HTTP Request: GET https://ec703bc455e9fe085c3fab7a4c274a50.oss.atoms.dev/1770624309735-California_Residential_Lease_Agreement.pdf?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Checksum-Mode=ENABLED&X-Amz-Credential=a05ea2f709c25b65a5e5567d8ca51890%2F20260209%2Fauto%2Fs3%2Faws4_request&X-Amz-Date=20260209T080517Z&X-Amz-Expires=600&X-Amz-SignedHeaders=host&x-id=GetObject&X-Amz-Signature=74a5f312964f850badf897ed1a90839386eff95a08fe5c0daa6d8694e97ad730 "HTTP/1.1 200 OK"
2026-02-09 00:05:17,402 - httpcore.http11 - DEBUG - receive_response_body.started request=<Request [b'GET']>
2026-02-09 00:05:17,406 - httpcore.http11 - DEBUG - receive_response_body.complete
2026-02-09 00:05:17,406 - httpcore.http11 - DEBUG - response_closed.started
2026-02-09 00:05:17,406 - httpcore.http11 - DEBUG - response_closed.complete
2026-02-09 00:05:17,406 - httpcore.connection - DEBUG - close.started
2026-02-09 00:05:17,407 - httpcore.connection - DEBUG - close.complete
2026-02-09 00:05:17,572 - routers.lease_analysis - INFO - Extracted 189 text blocks from pdf (6 pages)
2026-02-09 00:05:17,572 - core.config - DEBUG - Read dynamic attribute app_ai_base_url from environment variable APP_AI_BASE_URL
2026-02-09 00:05:17,572 - core.config - DEBUG - Read dynamic attribute app_ai_key from environment variable APP_AI_KEY
2026-02-09 00:05:17,607 - openai._base_client - DEBUG - Request options: {'method': 'post', 'url': '/chat/completions', 'files': None, 'json_data': {'messages': [{'role': 'system', 'content': 'You are a legal document analyzer specializing in residential lease agreements. Always respond with valid JSON only.'}, {'role': 'user', 'content': 'You are an expert lease agreement analyzer. Analyze the following lease document text and extract the key information.\n\nReturn a JSON object with the following fields (use null if not found):\n{\n  "tenant_name": "Full name of the tenant(s)",\n  "landlord_name": "Full name of the landlord/property owner",\n  "property_address": "Complete property address",\n  "monthly_rent": 0.00,\n  "security_deposit": 0.00,\n  "lease_start_date": "YYYY-MM-DD",\n  "lease_end_date": "YYYY-MM-DD",\n  "renewal_notice_days": 30,\n  "pet_policy": "Description of pet policy or \'Not specified\'",\n  "late_fee_terms": "Description of late fee terms or \'Not specified\'",\n  "risk_flags": [\n    {\n      "severity": "high|medium|low",\n      "category": "Category name",\n      "description": "Description of the risk or missing clause"\n    }\n  ]\n}\n\nCommon risk flags to check for:\n1. Missing lead-based paint disclosure (required for pre-1978 buildings)\n2. Missing security deposit return terms\n3. Unclear or missing late fee terms\n4. Missing maintenance responsibility clauses\n5. Missing entry notice requirements\n6. Missing subletting/assignment clauses\n7. Unusual or potentially unfair terms\n8. Missing dispute resolution procedures\n\nIMPORTANT: \n- Extract exact values from the document\n- For dates, convert to YYYY-MM-DD format\n- For monetary values, extract as numbers without currency symbols\n- Identify ALL potential risks and missing standard clauses\n- Return ONLY valid JSON, no additional text\n\nDocument text:\nCalifornia Residential Lease Agreement\nThis Lease Agreement (hereinafter referred to as the "Agreement") is signed by the following\ntwo parties on March 1, 2026, in Los Angeles, California, United States. Both parties voluntarily\nabide by all terms of this Agreement, which have equal legal effect.\nParty A (Landlord)\nLegal Name: Sarah Elizabeth Johnson\nCalifornia Driver‚Äôs License Number: A1234567\nContact Phone: +1 (213) 555-7890\nEmail Address: sarah.johnson@email.com\nPermanent Address: 456 Oak Street, Pasadena, CA 91101\nParty B (Tenant)\nLegal Name: Michael David Lee\nCalifornia Driver‚Äôs License Number: B7654321\nContact Phone: +1 (310) 555-1234\nEmail Address: michael.lee@email.com\nEmergency Contact: Lisa Marie Wang, Contact Phone: +1 (424) 555-5678, Relationship with\nTenant: Friend\nI. Rental Property Information\nProperty Address: 1234 Maple Avenue, Los Angeles, CA 90001 (hereinafter referred to as the\n"Property")\nProperty Type: Single-family Apartment, including 2 Bedrooms, 1.5 Bathrooms, 1 Living Room,\n1 Kitchen, 1 Balcony, with a building area of approximately 95 square meters (1022 square feet).\nIncluded Amenities: Built-in air conditioning, central heating, stainless steel refrigerator,\nwashing machine, dryer, gas stove, microwave oven, dishwasher, built-in wardrobe, outdoor\nfurniture on the balcony, full-house flooring, and 1 outdoor fixed parking space (Parking Space\nNumber: 12).\nUse of Property: The Property shall be used solely for the Tenant‚Äôs personal residence.\nCommercial operations, illegal activities, subletting, or subleasing to a third party are strictly\nprohibited. Unauthorized changes to the structure or use of the Property are strictly prohibited.\nII. Lease Term\n1. This Agreement is a Fixed-Term Lease, commencing on March 10, 2026, and ending on March\n9, 2027, for a total of 12 months. Upon the expiration of the Lease Term, this Agreement shall\nautomatically terminate, and the Tenant shall move out of the Property on the expiration date.\n2. If the Tenant wishes to renew the lease, he/she shall notify the Landlord in writing 30 days\nprior to the expiration of the Lease Term (i.e., before February 8, 2027). Both parties shall\nnegotiate the renewal terms separately and sign a new agreement. If the Tenant fails to submit\na renewal application on time or the two parties fail to reach a renewal agreement, the Tenant\nshall move out on time. Failure to move out on time shall be handled in accordance with the\nLiability for Breach of Contract in Article VII of this Agreement.\n3. During the Lease Term, the Tenant shall not terminate the Agreement early without\nauthorization. If there are special circumstances requiring early termination, the Tenant shall\nnotify the Landlord in writing 60 days in advance. After obtaining the Landlord‚Äôs written\nconsent, both parties shall complete the termination procedures. The Tenant shall pay a\nliquidated damages equivalent to one month‚Äôs rent, and the Landlord shall refund the\nremaining security deposit (if any) after deducting the liquidated damages.\nIII. Rent and Payment Terms\n1. The monthly rent for the Property is: 2,800 US Dollars (Two Thousand Eight Hundred US\nDollars). The rent includes the usage fee of the Property‚Äôs supporting facilities and\nHomeowners Association (HOA) Fees, but does not include electricity, water, gas, internet fees,\nor other fees incurred by the Tenant‚Äôs personal consumption.\n2. Rent Payment Date: The Tenant shall pay the monthly rent on or before the 5th day of each\nmonth without delay. The first rent shall be paid on the date of signing this Agreement, i.e.,\n2,000 US Dollars paid on March 1, 2026, for the period from March 10, 2026, to March 31, 2026\n(calculated based on the actual number of days of residence). Subsequent monthly rents shall\nbe paid in full at 2,800 US Dollars per month.\n3. Payment Method: The Tenant shall pay the rent to the Landlord‚Äôs designated bank account\nby bank transfer. After the transfer, the Tenant shall send the transfer receipt to the\nLandlord‚Äôs email address for filing.\nLandlord‚Äôs Bank Account Information:\nBank Name: Bank of America\nAccount Holder: Sarah Elizabeth Johnson\nAccount Number: 1234567890123\nRouting Number: 121000358\n4. Liability for Delay: If the Tenant delays paying the rent, he/she shall pay a late fee of 3% of\nthe monthly rent per day overdue. If the delay exceeds 15 days, the Landlord has the right to\nunilaterally terminate this Agreement, take back the Property, and pursue the Tenant‚Äôs\nliability for breach of contract.\nIV. Security Deposit\n1. On the date of signing this Agreement, the Tenant shall pay a security deposit to the\nLandlord in the amount of 2,800 US Dollars (equal to one month‚Äôs rent) as guarantee for the\nTenant‚Äôs performance of the obligations under this Agreement.\n2. Purpose of Security Deposit: It shall be used to compensate for the losses caused to the\nLandlord by the Tenant‚Äôs violation of the provisions of this Agreement (such as damage to the\nProperty‚Äôs facilities, arrears of rent, late fees, unpaid water and electricity fees, etc.). If the\nTenant has no breach of contract, the Property‚Äôs facilities are in good condition, and all\nrelevant fees have been settled, the Landlord shall refund the full security deposit without\ninterest to the Tenant‚Äôs designated bank account within 21 days after the expiration of the\nLease Term.\nTenant‚Äôs Bank Account Information:\nBank Name: Chase Bank\nAccount Holder: Michael David Lee\nAccount Number: 9876543210987\nRouting Number: 021000021\n3. If the Tenant has a breach of contract, the Landlord has the right to deduct the\ncorresponding losses from the security deposit. If there is any remaining after deduction, the\nremaining amount shall be refunded without interest. If the security deposit is insufficient to\ncover the Landlord‚Äôs losses, the Tenant shall make up the difference within 7 days after\nreceiving the Landlord‚Äôs notice.\nV. Rights and Obligations of Both Parties\n(I) Rights and Obligations of the Landlord\n1. The Landlord has the right to collect rent, security deposit, and late fees in accordance with\nthe provisions of this Agreement, and has the right to conduct reasonable inspections of the\nTenant‚Äôs use of the Property (a 24-hour written notice shall be given to the Tenant before the\ninspection).\n2. The Landlord shall ensure that the Property has a clear property right, no encumbrances\nsuch as mortgages or seizures, and that the Property and its supporting facilities are in normal\nusable condition at the time of delivery (except for normal wear and tear).\n3. The Landlord shall be responsible for structural maintenance of the Property (such as walls,\nroof, main water pipes, main electrical circuits, etc.). After receiving the Tenant‚Äôs maintenance\nnotice, the Landlord shall conduct maintenance within 7 days. If maintenance is not performed\non time, the Tenant may perform the maintenance by himself/herself, and the maintenance\ncosts shall be borne by the Landlord (the Tenant shall provide a formal maintenance invoice).\n4. The Landlord shall not unreasonably interfere with the Tenant‚Äôs normal residential use,\nand shall not enter the Property without authorization (except in emergency situations such as\nfire, water leakage, etc., and shall notify the Tenant in a timely manner afterwards).\n5. In accordance with California law, the Landlord shall disclose relevant information about the\nProperty to the Tenant: the Property was built in 2005, has no Lead-Based Paint, is equipped\nwith qualified Smoke Detectors and Carbon Monoxide Detectors, which shall be regularly\ninspected to ensure their normal operation.\n(II) Rights and Obligations of the Tenant\n1. The Tenant has the right to legally use the Property and its supporting facilities during the\nLease Term, and has the right to require the Landlord to perform property maintenance in\naccordance with the provisions of this Agreement.\n2. The Tenant shall pay the rent, security deposit, and water, electricity, gas, internet and other\nfees incurred by himself/herself in full and on time. Upon the expiration of the Lease Term, the\nTenant shall settle all fees and provide relevant settlement certificates.\n3. The Tenant shall properly keep the Property and its supporting facilities, and shall not\ndamage, modify, or disassemble the Property‚Äôs facilities without authorization. If the\nProperty‚Äôs facilities are damaged due to improper use or intentional damage by the Tenant,\nthe Tenant shall repair them in a timely manner or bear the corresponding maintenance costs.\n4. The Tenant shall comply with the relevant laws and regulations of California and the city of\nLos Angeles, and the property management regulations of the community. The Tenant shall\nnot engage in illegal activities (such as gambling, drug use, etc.) in the Property, shall not make\nnoise or disturb the neighbors, and shall not change the structure or use of the Property\nwithout authorization.\n5. During the Lease Term, if there is a maintenance problem with the Property (non-structural\nproblem), the Tenant shall notify the Landlord in writing in a timely manner and cooperate\nwith the Landlord in maintenance. If the loss is expanded due to the Tenant‚Äôs failure to notify\nin a timely manner, the Tenant shall bear the corresponding liability.\n6. The Tenant shall not sublet, sublease, or lend the Property to a third party without\nauthorization, and shall not use the Property for mortgage, guarantee, or other purposes.\n7. Upon the expiration of the Lease Term, the Tenant shall restore the Property and its\nsupporting facilities to the state at the time of delivery (except for normal wear and tear), clean\nup personal items in the Property, and return the house keys, access cards, etc., to the\nLandlord.\nVI. Property Maintenance and Upkeep\n1. The Landlord shall be responsible for structural maintenance of the Property, and the\nTenant shall be responsible for daily minor maintenance and upkeep of the Property (such as\nreplacing light bulbs, unclogging drains, replacing faucet washers, etc.), and the relevant costs\nshall be borne by the Tenant.\n2. During the Lease Term, if the Property is damaged due to force majeure (such as\nearthquakes, floods, typhoons, and other natural disasters), neither party shall bear liability to\nthe other. The Landlord shall refund the remaining rent and security deposit to the Tenant,\nand this Agreement shall automatically terminate.\n3. The Tenant shall not renovate or modify the Property without authorization. If renovation or\nmodification is really necessary, the Tenant shall notify the Landlord in writing in advance and\nmay proceed only after obtaining the Landlord‚Äôs written consent. The renovation costs shall\nbe borne by the Tenant. Upon the expiration of the Lease Term, the Tenant shall restore the\nrenovated part to its original state (unless the Landlord agrees in writing to retain it).\nVII. Breach of Contract\n1. Landlord‚Äôs Breach of Contract: If the Landlord fails to provide the Tenant with a normally\nusable Property in accordance with the provisions of this Agreement, or fails to perform\nstructural maintenance on time, resulting in the Tenant‚Äôs inability to live normally, the Tenant\nhas the right to require the Landlord to reduce or exempt the corresponding rent, or\nunilaterally terminate this Agreement. The Landlord shall refund the rent and security deposit\nalready paid by the Tenant and pay a liquidated damages equivalent to one month‚Äôs rent.\n2. Tenant‚Äôs Breach of Contract:\n(1) For delayed payment of rent or late fees, the Tenant shall bear liability in accordance with\nthe provisions of Section 4 of Article III of this Agreement. If the delay exceeds 15 days, the\nLandlord has the right to terminate the Agreement, take back the Property, confiscate the\nsecurity deposit, and require the Tenant to pay the arrears of rent and late fees.\n(2) If the Tenant arbitrarily damages the Property‚Äôs facilities or modifies the Property‚Äôs\nstructure, he/she shall bear the maintenance costs or compensate the Landlord for the losses.\nThe Landlord has the right to deduct the corresponding amount from the security deposit, and\nhas the right to recover the shortfall from the Tenant if the security deposit is insufficient.\n(3) If the Tenant arbitrarily sublets, subleases, or lends the Property, or uses it for illegal\nactivities or changes its use, the Landlord has the right to unilaterally terminate this\nAgreement, confiscate the security deposit, and require the Tenant to pay a liquidated\nÔºàÊ≥®ÔºöÊñáÊ°£ÈÉ®ÂàÜÂÜÖÂÆπÂèØËÉΩÁî± AI ÁîüÊàêÔºâ\ndamages equivalent to two months‚Äô rent. If the Tenant causes losses to the Landlord, the\nTenant shall make additional compensation.\n(4) After the expiration of the lease term, if the Tenant fails to move out on time, he/she shall\npay a liquidated damages of 5% of the monthly rent per day overdue. The Landlord has the\nright to forcibly take back the property, and all expenses incurred shall be borne by the Tenant.\nVIII. Miscellaneous Provisions\n1. This Agreement shall be governed by the laws of the State of California, United States. Any\ndispute arising from this Agreement shall be settled through negotiation between the two\nparties; if negotiation fails, either party may file a lawsuit with the people‚Äôs court having\njurisdiction over the location of the Property.\n2. This Agreement constitutes the entire agreement between the two parties regarding the\nrental of the Property, and supersedes all prior oral or written agreements, understandings,\nand commitments between the two parties.\n3. Any modification or supplement to this Agreement shall be made in writing and signed by\nboth parties to take effect.\n4. This Agreement is made in two copies, one for each party, and both copies have the same\nlegal effect.\nIX. Signatures of Both Parties\nLandlord‚Äôs Signature: ________________________ Date: March 1, 2026\nTenant‚Äôs Signature: ________________________ Date: March 1, 2026'}], 'model': 'gpt-5-chat', 'max_tokens': 4096, 'stream': False, 'temperature': 0.7}}
2026-02-09 00:05:17,609 - httpcore.connection - DEBUG - connect_tcp.started host='llmapi-api.deepwisdom.ai' port=443 local_address=None timeout=5.0 socket_options=None
2026-02-09 00:05:17,676 - httpcore.connection - DEBUG - connect_tcp.complete return_value=<httpcore._backends.anyio.AnyIOStream object at 0x7f04ebebb250>
2026-02-09 00:05:17,676 - httpcore.connection - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x7f04ebe7cf40> server_hostname='llmapi-api.deepwisdom.ai' timeout=5.0
2026-02-09 00:05:17,684 - httpcore.connection - DEBUG - start_tls.complete return_value=<httpcore._backends.anyio.AnyIOStream object at 0x7f04ebeb9f60>
2026-02-09 00:05:17,684 - httpcore.http11 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2026-02-09 00:05:17,685 - httpcore.http11 - DEBUG - send_request_headers.complete
2026-02-09 00:05:17,685 - httpcore.http11 - DEBUG - send_request_body.started request=<Request [b'POST']>
2026-02-09 00:05:17,685 - httpcore.http11 - DEBUG - send_request_body.complete
2026-02-09 00:05:17,685 - httpcore.http11 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2026-02-09 00:05:21,727 - httpcore.http11 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Mon, 09 Feb 2026 08:05:21 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'Content-Encoding', b'gzip'), (b'Apim-Request-Id', b'83bef485-bc90-47ce-a1bf-02aec202d549'), (b'Azureml-Model-Session', b'd20251215133231-f8b7a15f45ad4fe8'), (b'Strict-Transport-Security', b'max-age=31536000; includeSubDomains; preload'), (b'X-Content-Type-Options', b'nosniff'), (b'X-Ms-Deployment-Name', b'gpt-5-chat'), (b'X-Ms-Rai-Invoked', b'true'), (b'X-Ms-Region', b'Sweden Central'), (b'X-Oneapi-Request-Id', b'2026020900051771601929887357851'), (b'X-Oneapi-Trans-Id', b'19037975568449717'), (b'X-Ratelimit-Limit-Requests', b'5000'), (b'X-Ratelimit-Limit-Tokens', b'5000000'), (b'X-Ratelimit-Remaining-Requests', b'4999'), (b'X-Ratelimit-Remaining-Tokens', b'4996124'), (b'X-Request-Id', b'470e1c0e-a316-4262-bc41-68eaa73b9c67'), (b'cf-cache-status', b'DYNAMIC'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9cb1dc6188911d3e-LAX')])
2026-02-09 00:05:21,727 - httpx - INFO - HTTP Request: POST https://llmapi-api.deepwisdom.ai/v1/chat/completions "HTTP/1.1 200 OK"
2026-02-09 00:05:21,728 - httpcore.http11 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2026-02-09 00:05:21,728 - httpcore.http11 - DEBUG - receive_response_body.complete
2026-02-09 00:05:21,728 - httpcore.http11 - DEBUG - response_closed.started
2026-02-09 00:05:21,729 - httpcore.http11 - DEBUG - response_closed.complete
2026-02-09 00:05:21,729 - openai._base_client - DEBUG - HTTP Request: POST https://llmapi-api.deepwisdom.ai/v1/chat/completions "200 OK"
2026-02-09 00:05:22,052 - services.extractions - ERROR - Error creating extractions: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: column "source_map" of relation "extractions" does not exist
[SQL: INSERT INTO extractions (user_id, document_id, tenant_name, landlord_name, property_address, monthly_rent, security_deposit, lease_start_date, lease_end_date, renewal_notice_days, pet_policy, late_fee_terms, risk_flags, compliance_data, raw_extraction, source_map, pages_meta, created_at) VALUES ($1::VARCHAR, $2::INTEGER, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::FLOAT, $7::FLOAT, $8::VARCHAR, $9::VARCHAR, $10::INTEGER, $11::VARCHAR, $12::VARCHAR, $13::VARCHAR, $14::VARCHAR, $15::VARCHAR, $16::VARCHAR, $17::VARCHAR, $18::TIMESTAMP WITH TIME ZONE) RETURNING extractions.id]
[parameters: ('956410', 15, 'Michael David Lee', 'Sarah Elizabeth Johnson', '1234 Maple Avenue, Los Angeles, CA 90001', 2800.0, 2800.0, '2026-03-10', '2027-03-09', 30, 'Not specified', 'Late fee of 3% of the monthly rent per day overdue; if delay exceeds 15 days, landlord may terminate agreement, take back property, and pursue breach of contract liability.', "[{'severity': 'medium', 'category': 'Pet policy', 'description': 'No pet policy specified, which may lead to disputes over pet ownership or restricti ... (313 characters truncated) ... n': 'Dispute resolution limited to negotiation and court; lacks mediation or arbitration clauses which could offer alternative resolution methods.'}]", '{\'state_code\': \'CA\', \'state_name\': \'California\', \'regulations_found\': True, \'compliance_checks\': [{\'category\': \'security_deposit_limit ... (2563 characters truncated) ... comply with state law.\'}], \'overall_status\': \'warnings_found\', \'summary\': {\'compliant\': 1, \'warnings\': 1, \'violations\': 0, \'info\': 3}}', "{'tenant_name': 'Michael David Lee', 'landlord_name': 'Sarah Elizabeth Johnson', 'property_address': '1234 Maple Avenue, Los Angeles, CA 90001', 'mon ... (843 characters truncated) ... ': 'Dispute resolution limited to negotiation and court; lacks mediation or arbitration clauses which could offer alternative resolution methods.'}]}", '{"tenant_name": [{"page": 0, "bbox": {"x0": 28.0, "y0": 396.19, "x1": 202.65, "y1": 409.75}, "matched_text": "Legal Name: Michael David Lee", "match_ ... (2552 characters truncated) ... d_text": "prior to the expiration of the Lease Term (i.e., before February 8, 2027). Both parties shall", "match_type": "fuzzy", "confidence": 1.0}]}', '[{"page": 0, "width": 594.96, "height": 840.96}, {"page": 1, "width": 594.96, "height": 840.96}, {"page": 2, "width": 594.96, "height": 840.96}, {"page": 3, "width": 594.96, "height": 840.96}, {"page": 4, "width": 594.96, "height": 840.96}, {"page": 5, "width": 594.96, "height": 840.96}]', datetime.datetime(2026, 2, 9, 0, 5, 21, 869795))]
(Background on this error at: https://sqlalche.me/e/20/f405)
2026-02-09 00:05:22,052 - routers.lease_analysis - ERROR - Analysis error: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: column "source_map" of relation "extractions" does not exist
[SQL: INSERT INTO extractions (user_id, document_id, tenant_name, landlord_name, property_address, monthly_rent, security_deposit, lease_start_date, lease_end_date, renewal_notice_days, pet_policy, late_fee_terms, risk_flags, compliance_data, raw_extraction, source_map, pages_meta, created_at) VALUES ($1::VARCHAR, $2::INTEGER, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::FLOAT, $7::FLOAT, $8::VARCHAR, $9::VARCHAR, $10::INTEGER, $11::VARCHAR, $12::VARCHAR, $13::VARCHAR, $14::VARCHAR, $15::VARCHAR, $16::VARCHAR, $17::VARCHAR, $18::TIMESTAMP WITH TIME ZONE) RETURNING extractions.id]
[parameters: ('956410', 15, 'Michael David Lee', 'Sarah Elizabeth Johnson', '1234 Maple Avenue, Los Angeles, CA 90001', 2800.0, 2800.0, '2026-03-10', '2027-03-09', 30, 'Not specified', 'Late fee of 3% of the monthly rent per day overdue; if delay exceeds 15 days, landlord may terminate agreement, take back property, and pursue breach of contract liability.', "[{'severity': 'medium', 'category': 'Pet policy', 'description': 'No pet policy specified, which may lead to disputes over pet ownership or restricti ... (313 characters truncated) ... n': 'Dispute resolution limited to negotiation and court; lacks mediation or arbitration clauses which could offer alternative resolution methods.'}]", '{\'state_code\': \'CA\', \'state_name\': \'California\', \'regulations_found\': True, \'compliance_checks\': [{\'category\': \'security_deposit_limit ... (2563 characters truncated) ... comply with state law.\'}], \'overall_status\': \'warnings_found\', \'summary\': {\'compliant\': 1, \'warnings\': 1, \'violations\': 0, \'info\': 3}}', "{'tenant_name': 'Michael David Lee', 'landlord_name': 'Sarah Elizabeth Johnson', 'property_address': '1234 Maple Avenue, Los Angeles, CA 90001', 'mon ... (843 characters truncated) ... ': 'Dispute resolution limited to negotiation and court; lacks mediation or arbitration clauses which could offer alternative resolution methods.'}]}", '{"tenant_name": [{"page": 0, "bbox": {"x0": 28.0, "y0": 396.19, "x1": 202.65, "y1": 409.75}, "matched_text": "Legal Name: Michael David Lee", "match_ ... (2552 characters truncated) ... d_text": "prior to the expiration of the Lease Term (i.e., before February 8, 2027). Both parties shall", "match_type": "fuzzy", "confidence": 1.0}]}', '[{"page": 0, "width": 594.96, "height": 840.96}, {"page": 1, "width": 594.96, "height": 840.96}, {"page": 2, "width": 594.96, "height": 840.96}, {"page": 3, "width": 594.96, "height": 840.96}, {"page": 4, "width": 594.96, "height": 840.96}, {"page": 5, "width": 594.96, "height": 840.96}]', datetime.datetime(2026, 2, 9, 0, 5, 21, 869795))]
(Background on this error at: https://sqlalche.me/e/20/f405)
2026-02-09 00:05:22,053 - core.database - ERROR - Database session error: 500: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: column "source_map" of relation "extractions" does not exist
[SQL: INSERT INTO extractions (user_id, document_id, tenant_name, landlord_name, property_address, monthly_rent, security_deposit, lease_start_date, lease_end_date, renewal_notice_days, pet_policy, late_fee_terms, risk_flags, compliance_data, raw_extraction, source_map, pages_meta, created_at) VALUES ($1::VARCHAR, $2::INTEGER, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::FLOAT, $7::FLOAT, $8::VARCHAR, $9::VARCHAR, $10::INTEGER, $11::VARCHAR, $12::VARCHAR, $13::VARCHAR, $14::VARCHAR, $15::VARCHAR, $16::VARCHAR, $17::VARCHAR, $18::TIMESTAMP WITH TIME ZONE) RETURNING extractions.id]
[parameters: ('956410', 15, 'Michael David Lee', 'Sarah Elizabeth Johnson', '1234 Maple Avenue, Los Angeles, CA 90001', 2800.0, 2800.0, '2026-03-10', '2027-03-09', 30, 'Not specified', 'Late fee of 3% of the monthly rent per day overdue; if delay exceeds 15 days, landlord may terminate agreement, take back property, and pursue breach of contract liability.', "[{'severity': 'medium', 'category': 'Pet policy', 'description': 'No pet policy specified, which may lead to disputes over pet ownership or restricti ... (313 characters truncated) ... n': 'Dispute resolution limited to negotiation and court; lacks mediation or arbitration clauses which could offer alternative resolution methods.'}]", '{\'state_code\': \'CA\', \'state_name\': \'California\', \'regulations_found\': True, \'compliance_checks\': [{\'category\': \'security_deposit_limit ... (2563 characters truncated) ... comply with state law.\'}], \'overall_status\': \'warnings_found\', \'summary\': {\'compliant\': 1, \'warnings\': 1, \'violations\': 0, \'info\': 3}}', "{'tenant_name': 'Michael David Lee', 'landlord_name': 'Sarah Elizabeth Johnson', 'property_address': '1234 Maple Avenue, Los Angeles, CA 90001', 'mon ... (843 characters truncated) ... ': 'Dispute resolution limited to negotiation and court; lacks mediation or arbitration clauses which could offer alternative resolution methods.'}]}", '{"tenant_name": [{"page": 0, "bbox": {"x0": 28.0, "y0": 396.19, "x1": 202.65, "y1": 409.75}, "matched_text": "Legal Name: Michael David Lee", "match_ ... (2552 characters truncated) ... d_text": "prior to the expiration of the Lease Term (i.e., before February 8, 2027). Both parties shall", "match_type": "fuzzy", "confidence": 1.0}]}', '[{"page": 0, "width": 594.96, "height": 840.96}, {"page": 1, "width": 594.96, "height": 840.96}, {"page": 2, "width": 594.96, "height": 840.96}, {"page": 3, "width": 594.96, "height": 840.96}, {"page": 4, "width": 594.96, "height": 840.96}, {"page": 5, "width": 594.96, "height": 840.96}]', datetime.datetime(2026, 2, 9, 0, 5, 21, 869795))]
(Background on this error at: https://sqlalche.me/e/20/f405)
Traceback (most recent call last):
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 526, in _prepare_and_execute
    prepared_stmt, attributes = await adapt_connection._prepare(
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 773, in _prepare
    prepared_stmt = await self._connection.prepare(
  File "/data/.cache/python/lib/python3.10/site-packages/asyncpg/connection.py", line 638, in prepare
    return await self._prepare(
  File "/data/.cache/python/lib/python3.10/site-packages/asyncpg/connection.py", line 657, in _prepare
    stmt = await self._get_statement(
  File "/data/.cache/python/lib/python3.10/site-packages/asyncpg/connection.py", line 443, in _get_statement
    statement = await self._protocol.prepare(
  File "asyncpg/protocol/protocol.pyx", line 165, in prepare
asyncpg.exceptions.UndefinedColumnError: column "source_map" of relation "extractions" does not exist

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 952, in do_execute
    cursor.execute(statement, parameters)
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 585, in execute
    self._adapt_connection.await_(
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 563, in _prepare_and_execute
    self._handle_exception(error)
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 513, in _handle_exception
    self._adapt_connection._handle_exception(error)
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 797, in _handle_exception
    raise translated_error from error
sqlalchemy.dialects.postgresql.asyncpg.AsyncAdapt_asyncpg_dbapi.ProgrammingError: <class 'asyncpg.exceptions.UndefinedColumnError'>: column "source_map" of relation "extractions" does not exist

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/workspace/app/backend/routers/lease_analysis.py", line 164, in analyze_document
    extraction = await extractions_service.create({
  File "/workspace/app/backend/services/extractions.py", line 26, in create
    await self.db.commit()
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/ext/asyncio/session.py", line 1000, in commit
    await greenlet_spawn(self.sync_session.commit)
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2030, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/orm/state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 1311, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/orm/state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 1286, in _prepare_impl
    self.session.flush()
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 4331, in flush
    self._flush(objects)
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 4466, in _flush
    with util.safe_reraise():
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 4427, in _flush
    flush_context.execute()
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1419, in execute
    return meth(
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/sql/elements.py", line 527, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1846, in _execute_context
    return self._exec_single_context(
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2363, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 952, in do_execute
    cursor.execute(statement, parameters)
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 585, in execute
    self._adapt_connection.await_(
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 563, in _prepare_and_execute
    self._handle_exception(error)
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 513, in _handle_exception
    self._adapt_connection._handle_exception(error)
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 797, in _handle_exception
    raise translated_error from error
sqlalchemy.exc.ProgrammingError: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: column "source_map" of relation "extractions" does not exist
[SQL: INSERT INTO extractions (user_id, document_id, tenant_name, landlord_name, property_address, monthly_rent, security_deposit, lease_start_date, lease_end_date, renewal_notice_days, pet_policy, late_fee_terms, risk_flags, compliance_data, raw_extraction, source_map, pages_meta, created_at) VALUES ($1::VARCHAR, $2::INTEGER, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::FLOAT, $7::FLOAT, $8::VARCHAR, $9::VARCHAR, $10::INTEGER, $11::VARCHAR, $12::VARCHAR, $13::VARCHAR, $14::VARCHAR, $15::VARCHAR, $16::VARCHAR, $17::VARCHAR, $18::TIMESTAMP WITH TIME ZONE) RETURNING extractions.id]
[parameters: ('956410', 15, 'Michael David Lee', 'Sarah Elizabeth Johnson', '1234 Maple Avenue, Los Angeles, CA 90001', 2800.0, 2800.0, '2026-03-10', '2027-03-09', 30, 'Not specified', 'Late fee of 3% of the monthly rent per day overdue; if delay exceeds 15 days, landlord may terminate agreement, take back property, and pursue breach of contract liability.', "[{'severity': 'medium', 'category': 'Pet policy', 'description': 'No pet policy specified, which may lead to disputes over pet ownership or restricti ... (313 characters truncated) ... n': 'Dispute resolution limited to negotiation and court; lacks mediation or arbitration clauses which could offer alternative resolution methods.'}]", '{\'state_code\': \'CA\', \'state_name\': \'California\', \'regulations_found\': True, \'compliance_checks\': [{\'category\': \'security_deposit_limit ... (2563 characters truncated) ... comply with state law.\'}], \'overall_status\': \'warnings_found\', \'summary\': {\'compliant\': 1, \'warnings\': 1, \'violations\': 0, \'info\': 3}}', "{'tenant_name': 'Michael David Lee', 'landlord_name': 'Sarah Elizabeth Johnson', 'property_address': '1234 Maple Avenue, Los Angeles, CA 90001', 'mon ... (843 characters truncated) ... ': 'Dispute resolution limited to negotiation and court; lacks mediation or arbitration clauses which could offer alternative resolution methods.'}]}", '{"tenant_name": [{"page": 0, "bbox": {"x0": 28.0, "y0": 396.19, "x1": 202.65, "y1": 409.75}, "matched_text": "Legal Name: Michael David Lee", "match_ ... (2552 characters truncated) ... d_text": "prior to the expiration of the Lease Term (i.e., before February 8, 2027). Both parties shall", "match_type": "fuzzy", "confidence": 1.0}]}', '[{"page": 0, "width": 594.96, "height": 840.96}, {"page": 1, "width": 594.96, "height": 840.96}, {"page": 2, "width": 594.96, "height": 840.96}, {"page": 3, "width": 594.96, "height": 840.96}, {"page": 4, "width": 594.96, "height": 840.96}, {"page": 5, "width": 594.96, "height": 840.96}]', datetime.datetime(2026, 2, 9, 0, 5, 21, 869795))]
(Background on this error at: https://sqlalche.me/e/20/f405)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/workspace/app/backend/core/database.py", line 534, in get_db
    yield session
  File "/data/.cache/python/lib/python3.10/site-packages/fastapi/routing.py", line 107, in app
    response = await f(request)
  File "/data/.cache/python/lib/python3.10/site-packages/fastapi/routing.py", line 426, in app
    raw_response = await run_endpoint_function(
  File "/data/.cache/python/lib/python3.10/site-packages/fastapi/routing.py", line 314, in run_endpoint_function
    return await dependant.call(**values)
  File "/workspace/app/backend/routers/lease_analysis.py", line 212, in analyze_document
    raise HTTPException(status_code=500, detail=str(e))
fastapi.exceptions.HTTPException: 500: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: column "source_map" of relation "extractions" does not exist
[SQL: INSERT INTO extractions (user_id, document_id, tenant_name, landlord_name, property_address, monthly_rent, security_deposit, lease_start_date, lease_end_date, renewal_notice_days, pet_policy, late_fee_terms, risk_flags, compliance_data, raw_extraction, source_map, pages_meta, created_at) VALUES ($1::VARCHAR, $2::INTEGER, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::FLOAT, $7::FLOAT, $8::VARCHAR, $9::VARCHAR, $10::INTEGER, $11::VARCHAR, $12::VARCHAR, $13::VARCHAR, $14::VARCHAR, $15::VARCHAR, $16::VARCHAR, $17::VARCHAR, $18::TIMESTAMP WITH TIME ZONE) RETURNING extractions.id]
[parameters: ('956410', 15, 'Michael David Lee', 'Sarah Elizabeth Johnson', '1234 Maple Avenue, Los Angeles, CA 90001', 2800.0, 2800.0, '2026-03-10', '2027-03-09', 30, 'Not specified', 'Late fee of 3% of the monthly rent per day overdue; if delay exceeds 15 days, landlord may terminate agreement, take back property, and pursue breach of contract liability.', "[{'severity': 'medium', 'category': 'Pet policy', 'description': 'No pet policy specified, which may lead to disputes over pet ownership or restricti ... (313 characters truncated) ... n': 'Dispute resolution limited to negotiation and court; lacks mediation or arbitration clauses which could offer alternative resolution methods.'}]", '{\'state_code\': \'CA\', \'state_name\': \'California\', \'regulations_found\': True, \'compliance_checks\': [{\'category\': \'security_deposit_limit ... (2563 characters truncated) ... comply with state law.\'}], \'overall_status\': \'warnings_found\', \'summary\': {\'compliant\': 1, \'warnings\': 1, \'violations\': 0, \'info\': 3}}', "{'tenant_name': 'Michael David Lee', 'landlord_name': 'Sarah Elizabeth Johnson', 'property_address': '1234 Maple Avenue, Los Angeles, CA 90001', 'mon ... (843 characters truncated) ... ': 'Dispute resolution limited to negotiation and court; lacks mediation or arbitration clauses which could offer alternative resolution methods.'}]}", '{"tenant_name": [{"page": 0, "bbox": {"x0": 28.0, "y0": 396.19, "x1": 202.65, "y1": 409.75}, "matched_text": "Legal Name: Michael David Lee", "match_ ... (2552 characters truncated) ... d_text": "prior to the expiration of the Lease Term (i.e., before February 8, 2027). Both parties shall", "match_type": "fuzzy", "confidence": 1.0}]}', '[{"page": 0, "width": 594.96, "height": 840.96}, {"page": 1, "width": 594.96, "height": 840.96}, {"page": 2, "width": 594.96, "height": 840.96}, {"page": 3, "width": 594.96, "height": 840.96}, {"page": 4, "width": 594.96, "height": 840.96}, {"page": 5, "width": 594.96, "height": 840.96}]', datetime.datetime(2026, 2, 9, 0, 5, 21, 869795))]
(Background on this error at: https://sqlalche.me/e/20/f405)
2026-02-09 00:05:22,753 - core.database - DEBUG - [DB_OP] Database session cleanup after 6.7732s
2026-02-09 00:05:22,753 - core.database - ERROR - Failed to create database session: 500: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: column "source_map" of relation "extractions" does not exist
[SQL: INSERT INTO extractions (user_id, document_id, tenant_name, landlord_name, property_address, monthly_rent, security_deposit, lease_start_date, lease_end_date, renewal_notice_days, pet_policy, late_fee_terms, risk_flags, compliance_data, raw_extraction, source_map, pages_meta, created_at) VALUES ($1::VARCHAR, $2::INTEGER, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::FLOAT, $7::FLOAT, $8::VARCHAR, $9::VARCHAR, $10::INTEGER, $11::VARCHAR, $12::VARCHAR, $13::VARCHAR, $14::VARCHAR, $15::VARCHAR, $16::VARCHAR, $17::VARCHAR, $18::TIMESTAMP WITH TIME ZONE) RETURNING extractions.id]
[parameters: ('956410', 15, 'Michael David Lee', 'Sarah Elizabeth Johnson', '1234 Maple Avenue, Los Angeles, CA 90001', 2800.0, 2800.0, '2026-03-10', '2027-03-09', 30, 'Not specified', 'Late fee of 3% of the monthly rent per day overdue; if delay exceeds 15 days, landlord may terminate agreement, take back property, and pursue breach of contract liability.', "[{'severity': 'medium', 'category': 'Pet policy', 'description': 'No pet policy specified, which may lead to disputes over pet ownership or restricti ... (313 characters truncated) ... n': 'Dispute resolution limited to negotiation and court; lacks mediation or arbitration clauses which could offer alternative resolution methods.'}]", '{\'state_code\': \'CA\', \'state_name\': \'California\', \'regulations_found\': True, \'compliance_checks\': [{\'category\': \'security_deposit_limit ... (2563 characters truncated) ... comply with state law.\'}], \'overall_status\': \'warnings_found\', \'summary\': {\'compliant\': 1, \'warnings\': 1, \'violations\': 0, \'info\': 3}}', "{'tenant_name': 'Michael David Lee', 'landlord_name': 'Sarah Elizabeth Johnson', 'property_address': '1234 Maple Avenue, Los Angeles, CA 90001', 'mon ... (843 characters truncated) ... ': 'Dispute resolution limited to negotiation and court; lacks mediation or arbitration clauses which could offer alternative resolution methods.'}]}", '{"tenant_name": [{"page": 0, "bbox": {"x0": 28.0, "y0": 396.19, "x1": 202.65, "y1": 409.75}, "matched_text": "Legal Name: Michael David Lee", "match_ ... (2552 characters truncated) ... d_text": "prior to the expiration of the Lease Term (i.e., before February 8, 2027). Both parties shall", "match_type": "fuzzy", "confidence": 1.0}]}', '[{"page": 0, "width": 594.96, "height": 840.96}, {"page": 1, "width": 594.96, "height": 840.96}, {"page": 2, "width": 594.96, "height": 840.96}, {"page": 3, "width": 594.96, "height": 840.96}, {"page": 4, "width": 594.96, "height": 840.96}, {"page": 5, "width": 594.96, "height": 840.96}]', datetime.datetime(2026, 2, 9, 0, 5, 21, 869795))]
(Background on this error at: https://sqlalche.me/e/20/f405)
Traceback (most recent call last):
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 526, in _prepare_and_execute
    prepared_stmt, attributes = await adapt_connection._prepare(
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 773, in _prepare
    prepared_stmt = await self._connection.prepare(
  File "/data/.cache/python/lib/python3.10/site-packages/asyncpg/connection.py", line 638, in prepare
    return await self._prepare(
  File "/data/.cache/python/lib/python3.10/site-packages/asyncpg/connection.py", line 657, in _prepare
    stmt = await self._get_statement(
  File "/data/.cache/python/lib/python3.10/site-packages/asyncpg/connection.py", line 443, in _get_statement
    statement = await self._protocol.prepare(
  File "asyncpg/protocol/protocol.pyx", line 165, in prepare
asyncpg.exceptions.UndefinedColumnError: column "source_map" of relation "extractions" does not exist

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 952, in do_execute
    cursor.execute(statement, parameters)
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 585, in execute
    self._adapt_connection.await_(
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 563, in _prepare_and_execute
    self._handle_exception(error)
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 513, in _handle_exception
    self._adapt_connection._handle_exception(error)
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 797, in _handle_exception
    raise translated_error from error
sqlalchemy.dialects.postgresql.asyncpg.AsyncAdapt_asyncpg_dbapi.ProgrammingError: <class 'asyncpg.exceptions.UndefinedColumnError'>: column "source_map" of relation "extractions" does not exist

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/workspace/app/backend/routers/lease_analysis.py", line 164, in analyze_document
    extraction = await extractions_service.create({
  File "/workspace/app/backend/services/extractions.py", line 26, in create
    await self.db.commit()
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/ext/asyncio/session.py", line 1000, in commit
    await greenlet_spawn(self.sync_session.commit)
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 2030, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/orm/state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 1311, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/orm/state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 1286, in _prepare_impl
    self.session.flush()
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 4331, in flush
    self._flush(objects)
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 4466, in _flush
    with util.safe_reraise():
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/orm/session.py", line 4427, in _flush
    flush_context.execute()
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1419, in execute
    return meth(
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/sql/elements.py", line 527, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1846, in _execute_context
    return self._exec_single_context(
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 2363, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/engine/default.py", line 952, in do_execute
    cursor.execute(statement, parameters)
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 585, in execute
    self._adapt_connection.await_(
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 563, in _prepare_and_execute
    self._handle_exception(error)
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 513, in _handle_exception
    self._adapt_connection._handle_exception(error)
  File "/data/.cache/python/lib/python3.10/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 797, in _handle_exception
    raise translated_error from error
sqlalchemy.exc.ProgrammingError: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: column "source_map" of relation "extractions" does not exist
[SQL: INSERT INTO extractions (user_id, document_id, tenant_name, landlord_name, property_address, monthly_rent, security_deposit, lease_start_date, lease_end_date, renewal_notice_days, pet_policy, late_fee_terms, risk_flags, compliance_data, raw_extraction, source_map, pages_meta, created_at) VALUES ($1::VARCHAR, $2::INTEGER, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::FLOAT, $7::FLOAT, $8::VARCHAR, $9::VARCHAR, $10::INTEGER, $11::VARCHAR, $12::VARCHAR, $13::VARCHAR, $14::VARCHAR, $15::VARCHAR, $16::VARCHAR, $17::VARCHAR, $18::TIMESTAMP WITH TIME ZONE) RETURNING extractions.id]
[parameters: ('956410', 15, 'Michael David Lee', 'Sarah Elizabeth Johnson', '1234 Maple Avenue, Los Angeles, CA 90001', 2800.0, 2800.0, '2026-03-10', '2027-03-09', 30, 'Not specified', 'Late fee of 3% of the monthly rent per day overdue; if delay exceeds 15 days, landlord may terminate agreement, take back property, and pursue breach of contract liability.', "[{'severity': 'medium', 'category': 'Pet policy', 'description': 'No pet policy specified, which may lead to disputes over pet ownership or restricti ... (313 characters truncated) ... n': 'Dispute resolution limited to negotiation and court; lacks mediation or arbitration clauses which could offer alternative resolution methods.'}]", '{\'state_code\': \'CA\', \'state_name\': \'California\', \'regulations_found\': True, \'compliance_checks\': [{\'category\': \'security_deposit_limit ... (2563 characters truncated) ... comply with state law.\'}], \'overall_status\': \'warnings_found\', \'summary\': {\'compliant\': 1, \'warnings\': 1, \'violations\': 0, \'info\': 3}}', "{'tenant_name': 'Michael David Lee', 'landlord_name': 'Sarah Elizabeth Johnson', 'property_address': '1234 Maple Avenue, Los Angeles, CA 90001', 'mon ... (843 characters truncated) ... ': 'Dispute resolution limited to negotiation and court; lacks mediation or arbitration clauses which could offer alternative resolution methods.'}]}", '{"tenant_name": [{"page": 0, "bbox": {"x0": 28.0, "y0": 396.19, "x1": 202.65, "y1": 409.75}, "matched_text": "Legal Name: Michael David Lee", "match_ ... (2552 characters truncated) ... d_text": "prior to the expiration of the Lease Term (i.e., before February 8, 2027). Both parties shall", "match_type": "fuzzy", "confidence": 1.0}]}', '[{"page": 0, "width": 594.96, "height": 840.96}, {"page": 1, "width": 594.96, "height": 840.96}, {"page": 2, "width": 594.96, "height": 840.96}, {"page": 3, "width": 594.96, "height": 840.96}, {"page": 4, "width": 594.96, "height": 840.96}, {"page": 5, "width": 594.96, "height": 840.96}]', datetime.datetime(2026, 2, 9, 0, 5, 21, 869795))]
(Background on this error at: https://sqlalche.me/e/20/f405)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/workspace/app/backend/core/database.py", line 534, in get_db
    yield session
  File "/data/.cache/python/lib/python3.10/site-packages/fastapi/routing.py", line 107, in app
    response = await f(request)
  File "/data/.cache/python/lib/python3.10/site-packages/fastapi/routing.py", line 426, in app
    raw_response = await run_endpoint_function(
  File "/data/.cache/python/lib/python3.10/site-packages/fastapi/routing.py", line 314, in run_endpoint_function
    return await dependant.call(**values)
  File "/workspace/app/backend/routers/lease_analysis.py", line 212, in analyze_document
    raise HTTPException(status_code=500, detail=str(e))
fastapi.exceptions.HTTPException: 500: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: column "source_map" of relation "extractions" does not exist
[SQL: INSERT INTO extractions (user_id, document_id, tenant_name, landlord_name, property_address, monthly_rent, security_deposit, lease_start_date, lease_end_date, renewal_notice_days, pet_policy, late_fee_terms, risk_flags, compliance_data, raw_extraction, source_map, pages_meta, created_at) VALUES ($1::VARCHAR, $2::INTEGER, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::FLOAT, $7::FLOAT, $8::VARCHAR, $9::VARCHAR, $10::INTEGER, $11::VARCHAR, $12::VARCHAR, $13::VARCHAR, $14::VARCHAR, $15::VARCHAR, $16::VARCHAR, $17::VARCHAR, $18::TIMESTAMP WITH TIME ZONE) RETURNING extractions.id]
[parameters: ('956410', 15, 'Michael David Lee', 'Sarah Elizabeth Johnson', '1234 Maple Avenue, Los Angeles, CA 90001', 2800.0, 2800.0, '2026-03-10', '2027-03-09', 30, 'Not specified', 'Late fee of 3% of the monthly rent per day overdue; if delay exceeds 15 days, landlord may terminate agreement, take back property, and pursue breach of contract liability.', "[{'severity': 'medium', 'category': 'Pet policy', 'description': 'No pet policy specified, which may lead to disputes over pet ownership or restricti ... (313 characters truncated) ... n': 'Dispute resolution limited to negotiation and court; lacks mediation or arbitration clauses which could offer alternative resolution methods.'}]", '{\'state_code\': \'CA\', \'state_name\': \'California\', \'regulations_found\': True, \'compliance_checks\': [{\'category\': \'security_deposit_limit ... (2563 characters truncated) ... comply with state law.\'}], \'overall_status\': \'warnings_found\', \'summary\': {\'compliant\': 1, \'warnings\': 1, \'violations\': 0, \'info\': 3}}', "{'tenant_name': 'Michael David Lee', 'landlord_name': 'Sarah Elizabeth Johnson', 'property_address': '1234 Maple Avenue, Los Angeles, CA 90001', 'mon ... (843 characters truncated) ... ': 'Dispute resolution limited to negotiation and court; lacks mediation or arbitration clauses which could offer alternative resolution methods.'}]}", '{"tenant_name": [{"page": 0, "bbox": {"x0": 28.0, "y0": 396.19, "x1": 202.65, "y1": 409.75}, "matched_text": "Legal Name: Michael David Lee", "match_ ... (2552 characters truncated) ... d_text": "prior to the expiration of the Lease Term (i.e., before February 8, 2027). Both parties shall", "match_type": "fuzzy", "confidence": 1.0}]}', '[{"page": 0, "width": 594.96, "height": 840.96}, {"page": 1, "width": 594.96, "height": 840.96}, {"page": 2, "width": 594.96, "height": 840.96}, {"page": 3, "width": 594.96, "height": 840.96}, {"page": 4, "width": 594.96, "height": 840.96}, {"page": 5, "width": 594.96, "height": 840.96}]', datetime.datetime(2026, 2, 9, 0, 5, 21, 869795))]
(Background on this error at: https://sqlalche.me/e/20/f405)
2026-02-09 00:07:02,042 - services.database - DEBUG - [DB_OP] Starting database close
2026-02-09 00:07:02,043 - core.database - INFO - Database connection closed and engine disposed
2026-02-09 00:07:02,043 - services.database - INFO - Database connections closed
2026-02-09 00:07:02,043 - services.database - DEBUG - [DB_OP] Database close completed in 0.0011s
